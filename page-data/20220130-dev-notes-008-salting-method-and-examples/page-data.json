{"componentChunkName":"component---src-templates-post-tsx","path":"/20220130-dev-notes-008-salting-method-and-examples/","result":{"data":{"site":{"siteMetadata":{"title":"MESH KOREA | VROONG 테크 블로그","description":"메쉬코리아에서 기술, 유저 경험 및 공간 디자인, 서비스 기획 등 물류플랫폼을 만들기 위한 과정에 대한 고민과 그 해결을 담은 블로그입니다."}},"markdownRemark":{"html":"<blockquote>\n<p>이 글에서는 salting 기법을 기본 버전, 심화 버전의 pyspark 코드로 보여드립니다.</p>\n</blockquote>\n<p>데이터 엔지니어링 과정에서 두 개 이상의 데이터를 JOIN 할 때 특정 키(key)에 데이터가 집중되는 경우가\n발생할 수 있습니다. 이런 것을 데이터 쏠림(skew)이라 합니다. 데이터 쏠림은 분산 처리의 효율을 떨어뜨리거나,\n데이터 파이프라인 장애를 일으키는 주 원인중 하나로 알려져 있습니다.</p>\n<p>Salting은 데이터 쏠림에 대한 대응책으로 자주 쓰이는 데이터 엔지니어링 기법입니다. salting이라는 용어는\n말 그대로 소금뿌리기 정도로 이해하시면 좋습니다. 실제 구현을 보면 왜 그런지 이해가 가실 것입니다.\n이 글에서는 salting 기법을 기본 버전, 심화 버전의 pyspark 코드로 보여드립니다.\nspark의 직관적인 API 덕분에 salting의 실제 구현 방식을 쉽게 확인하실 수 있으실 것입니다.\n물론, salting 기법은 MapReduce에서도 동일한 방식으로 활용할 수 있습니다.</p>\n<h3 id=\"쏠림이-발생하는-데이터\"><a href=\"#%EC%8F%A0%EB%A6%BC%EC%9D%B4-%EB%B0%9C%EC%83%9D%ED%95%98%EB%8A%94-%EB%8D%B0%EC%9D%B4%ED%84%B0\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>쏠림이 발생하는 데이터</h3>\n<p>서울에서 전국 달리기 대회를 개최했습니다. 총 190 여명의 선수가 참가했으며, 다음과 같은 선수 데이터가 만들어 졌습니다.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: -70px; margin-right: -70px; text-align: center; max-width: 600px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 53.06122448979592%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAADhklEQVQozwF7A4T8ALjUpvuasor5wN2t973dqfi62Kj5nbWN+aO8k/a/3qz3v96r+rTPoviVrIb2psCW98Hervm72qf5wN2t+cDdrfaet472vdqq9MHerv+52aTAALLRnj2jwo47j6h/Tpa4gFG43KI9m7iIP26CYlqCnXFbueCfQZizh0Vkd1hfeY9qVLnboz6q0JFHt9iiPXuSbVxne1tgeI5pXLnZpD6kzYk8AP///wCuAP8AAAAAExdFABf///8AAAAAAQAAACAAFwAfE5YABgAAAAEAAAAhAAAAEP///wAxhwAN////AAAAAB8AAAAmAAAAI////wBJlRYQAHy0Vw6X32kNN1AnIVWAOSaU22YPa5xKEic5HC4+XCosiMtcFV2HQhMiMhg6MkojJpLXZQ54tVEcfLVXDyg6HDMkNRk2JzobM3uzVw53tE8bAGmiQQuJ1VYLLEQbHU14MSOI01YMV4Y2ECM2FiQ1UyEpg8tSEjxdJhQgMhQtJzwYJHe5Sw1xrkcZaKJBDCEzFSwcKxEzHzATMHCtRgtvrEYZAGihQgWk/mgFHSwSFVF/MxqU5l4HUXwzCRAZCiQqQRoljttZDCxEHAwRGwsuFSENIo3ZWQZ0tEkTWIc3BxglDyEUHwwmFyQOI2GWPQVysEgUAGunRQ+EzVQOM1AhIVWFNiSAyFIQYJU9EyI2FjA5WCQueb1NF2GXPhEhNBU4OFckIITNVA9ysUgcYZY+EiI2FjYjNxY0JToYMmunRA9xr0cbAF2TPQWs/28EFyQPF0lyLhyT5l4GVYU3Bw8XCiMpPxoljNpYDCc9GQwUHw0lFyQPHH3DUAd0tEoSSXIvBxIcCykSHAsnFCANJFeJOQVxr0cUAGqiQQ2R3loLKT8ZI0pyLieN2lgNWYk3ER4uEi8wSh4xgcdQE054MBIaKRA9KD0YJ4bPVA1uqkUbf8JOCy9IHSIfMBMzMUweIXy+TQtvq0UaAHCuRwiCy1MJOlslEVyPOhyAyFELY5o/CzFMHxRIby0cdrdKEmumRAksRRwbRm0sEIHJUgpwr0cXjdtZB0hwLhAtRhwaUoA0D4jUVwdvrUYYAG6pRQlvrEYLaqNDCm2pRRNuqkUMc7JJCpPkXQdqpEMQbalFEXS0Sgl+w1AJdLNJCm6rRgxxr0gTa6ZECnq9TQpzskkKeLlMCmynRApvrUYTpcw3ykKPxaAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Table 1\"\n        title=\"\"\n        src=\"/static/77709d36004dca8b8e5323c0511434c7/ff59c/table1.png\"\n        srcset=\"/static/77709d36004dca8b8e5323c0511434c7/232f7/table1.png 245w,\n/static/77709d36004dca8b8e5323c0511434c7/9319d/table1.png 490w,\n/static/77709d36004dca8b8e5323c0511434c7/ff59c/table1.png 600w\"\n        sizes=\"(max-width: 600px) 100vw, 600px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>아무래도 서울에서 개최된 경기이다보니, 서울 근처에서 가장 많이들 참가하였습니다. 지역별 참가자 수는 다음과 같습니다.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: -70px; margin-right: -70px; text-align: center; max-width: 300px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 161.22448979591837%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Table 2\"\n        title=\"\"\n        src=\"/static/a7095d5ea798b470bc82139c479a7bc1/f2d49/table2.png\"\n        srcset=\"/static/a7095d5ea798b470bc82139c479a7bc1/232f7/table2.png 245w,\n/static/a7095d5ea798b470bc82139c479a7bc1/f2d49/table2.png 300w\"\n        sizes=\"(max-width: 300px) 100vw, 300px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>모종의 데이터 분석을 위해, 여기에 각 지역의 평균 연령 데이터를 Join한다고 가정해 봅시다.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: -70px; margin-right: -70px; text-align: center; max-width: 300px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 160.81632653061223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,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'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Table 3\"\n        title=\"\"\n        src=\"/static/ffb40274ac1f1e62a7b23e97a9b2e44f/f2d49/table3.png\"\n        srcset=\"/static/ffb40274ac1f1e62a7b23e97a9b2e44f/232f7/table3.png 245w,\n/static/ffb40274ac1f1e62a7b23e97a9b2e44f/f2d49/table3.png 300w\"\n        sizes=\"(max-width: 300px) 100vw, 300px\"\n      />\n    </span>\n  </span>\n  </p>\n<h3 id=\"일반-join\"><a href=\"#%EC%9D%BC%EB%B0%98-join\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>일반 Join</h3>\n<p>우선 salting 없이 그냥 JOIN하려면 다음과 같이 하면 됩니다. </p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">joined_1 <span class=\"token operator\">=</span> runner<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>city<span class=\"token punctuation\">,</span> on<span class=\"token operator\">=</span><span class=\"token string\">'city'</span><span class=\"token punctuation\">,</span> how<span class=\"token operator\">=</span><span class=\"token string\">'left'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>코드에서 선수 데이터와 광역단체 데이터는, 각각 spark DataFrame <code class=\"language-text\">runner</code>와 <code class=\"language-text\">city</code>에 해당합니다.\n이 코드는 대부분의 시스템에서 문제없이 돌아갈 것이나, 동작 과정을 분석해보면 데이터 쏠림으로 인해\n대부분의 spark 파티션(partition)이 5개 이하의 데이터만 처리하는 동안에, 두 개 파티션이 대부분이 데이터를\n처리하게 됩니다. spark UI를 통해 데이터 분산 처리 내역을 다음과 같이 확인할 수 있습니다.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: -70px; margin-right: -70px; text-align: center; max-width: 980px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 50.61224489795918%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB2klEQVQoz42S3Y7bIBCF/f7v0/tKvWyrrlTFbFZrJ46T+Cc2BoMNDAxTQTe92KuOdKzBxh/nAEVzvcGvnz/wfKpxlBq5VNhNHNl7jc2lRSFE1rquyDlHpdSnXqK11htjyFp7KH4/DH5rNyonS6fFUL8FOgtLlxUIIv1vYXrEGMviPC7hNGmSm40UMS6cR8QQjdnjpnVCRudcFEJEKWUMIUREjELIKCWPxrzHVY2olCZELItpHAKYncZhiFprut1uZJ2jYRioqqoUg4QQdLlcaJom+hvNUFXV1DRfiU8vNLffcZ44OWfLYtv34AASKO77TgCQrNOyLBmYFlFKZWiqEDwZA3S/M1r4GwEQRdshBiTvfVkIIYJzjrquy8Bt2yiEQJxzquv6H3Ce5/RDXvAJ5Pyax+B7BMjfymJd1wzs+z4DkxAxA58O13XN4/T+6bDvjjTPAwFICv4FASIBuAwE5xx2XYf7vmelmucZq6pCrXW+HuM4ojHmQx7vtxLFckAPJXpofQJ6gEOR4nw4pM8On5HTNqS+aZp8WOmg0nytjhTCnPcxRweoCinlwTnH2rZl27ZlISJ7PB7s9fWVKaWyjscjq+uadV3HrLXser2yZdHM+8gA3CHBAODLH+XW9+JubNJSAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"일반 JOIN 동작 과정\"\n        title=\"\"\n        src=\"/static/27a84036bd6ff48617b8cec0cd4e2e25/2b72d/join1.png\"\n        srcset=\"/static/27a84036bd6ff48617b8cec0cd4e2e25/232f7/join1.png 245w,\n/static/27a84036bd6ff48617b8cec0cd4e2e25/9319d/join1.png 490w,\n/static/27a84036bd6ff48617b8cec0cd4e2e25/2b72d/join1.png 980w,\n/static/27a84036bd6ff48617b8cec0cd4e2e25/814a3/join1.png 1470w,\n/static/27a84036bd6ff48617b8cec0cd4e2e25/de62a/join1.png 1828w\"\n        sizes=\"(max-width: 980px) 100vw, 980px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>이렇게 되는 이유는 선수들이 서울과 경기도에 몰려 있고 <code class=\"language-text\">city</code>를 key로 JOIN 할 경우 서울이나 경기도를\n처리하는 JOIN 파티션에 이 데이터들이 전부 몰려가기 때문입니다.</p>\n<p>현재 예로 사용중인 데이터는 작은 크기이기 때문에, 각 파티션이 동작하는 시간에는 거의 차이가 느껴지지 않습니다만,\n데이터의 규모가 커지거나 각 데이터에 대한 계산 과정이 복잡해진다면, 이 정도의 쏠림은 충분히 문제가 됩니다.\n데이터가 많이 모이는 파티션의 처리 시간은 전체 실행 시간의 bottleneck이 되며,\n심하면 메모리 문제로 해당 파티션이 죽음으로써, 전체 앱이 실패할 수 도 있습니다.</p>\n<h3 id=\"salting-join---기본-버전\"><a href=\"#salting-join---%EA%B8%B0%EB%B3%B8-%EB%B2%84%EC%A0%84\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Salting Join - 기본 버전</h3>\n<p>이제 salting 기법을 이용해 데이터 쏠림을 완화해 보겠습니다. 우선 간단한 버전의 코드는 다음과 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">salt_size <span class=\"token operator\">=</span> <span class=\"token number\">10</span>\n\nrunner_2 <span class=\"token operator\">=</span> runner<span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"salt\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>rand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> salt_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>cast<span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">.</span>IntegerType<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n@F<span class=\"token punctuation\">.</span>udf<span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">.</span>ArrayType<span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">.</span>IntegerType<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">salt_array_udf</span><span class=\"token punctuation\">(</span>salt_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> salt_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ncity_2 <span class=\"token operator\">=</span> city<span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"salt\"</span><span class=\"token punctuation\">,</span> F<span class=\"token punctuation\">.</span>explode<span class=\"token punctuation\">(</span>salt_array_udf<span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>lit<span class=\"token punctuation\">(</span>salt_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\njoined_2 <span class=\"token operator\">=</span> runner_2<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>city_2<span class=\"token punctuation\">,</span> on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'city'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'salt'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> how<span class=\"token operator\">=</span><span class=\"token string\">'left'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>이 코드는 다음과 같은 일을 합니다.</p>\n<ol>\n<li>소금 크기(<code class=\"language-text\">salt_size</code>)라는 변수를 정의합니다.</li>\n<li><code class=\"language-text\">runner</code> 데이터에 소금(<code class=\"language-text\">salt</code>) 열(column)을 추가합니다. 이 열의 값은 0과 9사이의 랜덤 정수값입니다.</li>\n<li><code class=\"language-text\">city</code> 데이터에 소금(<code class=\"language-text\">salt</code>) 열을 추가합니다. 이 열의 값은 0에서 9까지 모든 정수 값입니다.\n즉, 기존 데이터의 1개 행을 10개 행으로 복제하고, 각각 값이 0 ~ 9인 소금 열을 추가해 줍니다.\n이 과정에서 0 ~ 9값을 가지는 array 를 생성해주는 함수(<code class=\"language-text\">salt_array_udf</code>)를 활용합니다.</li>\n<li>소금(<code class=\"language-text\">salt</code>) 열이 추가된 두 개 데이터를 JOIN 하는데, key로는 <code class=\"language-text\">city</code>, <code class=\"language-text\">salt</code> 둘 다 사용합니다.</li>\n</ol>\n<p>소금 열이 추가된 선수 데이터 <code class=\"language-text\">runner_2</code>는 다음과 같은 형태입니다.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: -70px; margin-right: -70px; text-align: center; max-width: 700px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 56.326530612244895%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAADhklEQVQozwF7A4T8ALzbqOafuJDrttOk6b/eq+umv5XqoLmR6brYp+nA36zroruT6Zmxiui51qfrvNup68PhsOqwzJ/oqMOY6MTisem+3Krrs8+h66S9lOu826jnAKPOhziTsYAtb4leSaLKhzeYuIQuYXZUR3eTZUe245kxb4ZgPlZpSVCpzZIuqNOLNpKwfzhbb09TWW1NUoijdzuq1Y41o8mKMZKvfzCEqG1EAFqnJhMZdAAGGDcEIEyWGREeYwAJCRkAJxw7BiFq1yALDCcAFg4hAScumAAGWq0iEQgvABEHFgAwCRoALQAcABRYrx4PR50NCwtTAAc5axcdAH69VBRnjkwHLkQfIni0URJTdTwLFyIRKT1bKh2a5WgNIjAZGhsnEylTeDsOjNJdET5YLBEYIxEtGSUSLC1AIRSGyVoQf7xXDFZ3QAlRejYfAHW2ShZSgTQKNFEhIHGxSBRSgDQMGysRJj5hJx2Cy1MQHjATIBknEDA6WyUViNNVEjdXIxQYJg8xGigQLypCGxd6v00Sb65HD057MgtRfjMgAHe5TBlekTsMNVMiJXGvRxZlnUANHzATLTVSISmU5F0QKD4ZIBwsEjZWhjcSgslRFT9hKBcdLhMzHzAUMTNOIBp8wU4VdbVKEVOBNQ5OeTElAHS1ShhajjkLNVMiI2+uRxZWhzYOHS4SKzdWIyWM21kQLEUcGyAyFCx8w08Ld7pLFjteJhYaKRA1HCsRMy5IHRp6v00Ub69HEFKBNA1RfjMiAHm7TRVYhzgJNFEhH3e4TBJUgjYLGScQKDpaJR+W518OJTkYGR0tEihglD0MgMZREztbJhIYJg8uGigQLSxDHBV/xVARdLRKDlmJOQlXiDcdAHW2ShRRgTMHKD8ZI2mkQhNYizgIFiMOJDJPICCO3VoNGSgQHBQgDS46WyURiNNVEDBMHhITHwwwFSINLSI2FRV8wk4QbqxFDUt2MAhTgjQcAHa3SxlglD0MNlQiJG+sRhdlnEANITMVKT1eJiON2lkRLkgdGyAyFC55vE0MebxMFkFmKRYfMBMwIDIULzRRIRh6vk0VdLVKEVOANA5OejElAHOySRlxr0cLaqRDE26rRRd0tEkMfsRQC2ynRBRysUgVca9HDHKxSA1xr0cOb6tFGHq9TQx9wU8MebxMDX/FUAturEYXca9HEWynRAtqpUMak9YhJgPNZfYAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Table 4\"\n        title=\"\"\n        src=\"/static/dd4c98e1dba4c0a1e96852199eec9dcd/39600/table4.png\"\n        srcset=\"/static/dd4c98e1dba4c0a1e96852199eec9dcd/232f7/table4.png 245w,\n/static/dd4c98e1dba4c0a1e96852199eec9dcd/9319d/table4.png 490w,\n/static/dd4c98e1dba4c0a1e96852199eec9dcd/39600/table4.png 700w\"\n        sizes=\"(max-width: 700px) 100vw, 700px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>소금 열이 추가된 지역데이터 <code class=\"language-text\">city_2</code> 는 다음과 같은 형태입니다. 각 행이 10개씩 복제되어 데이터 크기가 10배로 커졌습니다.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: -70px; margin-right: -70px; text-align: center; max-width: 400px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 95.10204081632654%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAAAsTAAALEwEAmpwYAAAFNklEQVQ4y3XT609TZxwH8OfFMnp6Tu/X01qgaGlpaYtSpICjaM9zeuMmzoibGKdgFM45QNHCoFwWp87bvLDMZFPZVKQ9p4JclFUMFy/Z3izOJep0c2PL/oS9WDaXsxwgW7ZsL355nuR5nuSXz+/7gPSz4V/vLo7xU48u/3bx1snf57+//nL+xXX+9vNr/J3nSf7C1En+yuwg/9Hkcf7q7OAfC4vXX6afDfPCnfSTa/z5G+/xEw8/4Rd+GBXefAduPh2KT3893HsueWiw92zb4ND0+6fSj0e6bz4d6p95PtJ9fuxo58dTJ7o+nTkT+4A7fGR4fvDE1ONLA/MvRmPpJyNdF2+d6rz56HLszjfJ+PD9s90AdAARAOAVAEAeAMAKAMjieR6ACMgQ1ntD34Jf5ngwfeoRAACoAQAmUA4Q4Uyon0Z5wP+8vAd5wADemdtuIHd61Zl2XYnJpinOLTK5tkb9iv50vaF/qkHRP7YL7UntkHz4VZs4f4M5xxPKtb89/rrx3P0O8ZF0k2RgfBd2fG4f1pfYg751xm8GB6fD2b49NpPZo9mUU6TxWTfovZWdBXh0PJhNJQk9zUEllSDU3bNVCrvf6C6ozCyiWWhuGyUVNAfVNAtVB2+FlVsPr9dWda11gc7bEb0zaFJpc6TFmhxJkcEmd5ftzJVFJ0L6lgQho1MQ2XfVj57+8U2RyaVabSnR5TMpEm8bD4ooDqIUC8XxezXIxr15EqLZYQOdMxHcHc7U4lZZiT5XVmxyKd2+3VZFx2QIpxKE0AXakvBjvfdrxGaPxmIrx11UgjC2jwcQmiUwiiWwrpkIGom5paGoyyZ0qLX5cIUqEytSmtBCvUVm99SZJR2TIW3LCCGhOZjRPOxHjj/dlmG0K7IspTorzUJddCL4Ks1ChEoSop6FalFFo00cirpWLxvu/m9DOknomWVDlWDo2GR0F0RWDMcCCmbFMPZZRLllwKMLRV1rQUwwDKwYmqWCoausYcVwBMpojkT2XfGjpxd3LBmuEQw5Em+7ERRRLIlSSSiO361FKprsEv9+R96yYcik1efKvEuGTqW7/G9DOZ2CKJXwY30PasTmQrVg6KSShLF9IoDQHMSoJCH4ohVNNrl/v92xbFhukP+fIcORK4b1/zIMLRnSLBTFpiOi2nihqG7AkwVi/zQsFwyr/jKEeoYjlXQCqnpmq5cM11ZmFTEsNLePBhQMS6oZFqo605XKzX2FumCrUzAM612hJUOvJkey3pAnGFpk0YmgvmWEkNEcgey/ugk9vfiGyORSCjl0MimIt90gRTRLoFSSEPc9qEF8u63SjXvz7KDrTiXuJE063Cr34lZ5kcmpLKhozFsxhAqGC6BUAmJ9DzaLzYUai81ncAo5jE6EEZojMZolsfhCLUo058uJZocD9CxUazNdKi1uldvUWRK30a6wrKvOlh6YCq/kUDAkkGNP6jOMDkWmpVSfy3BQ1z4uGJIIlYCi/s/rMkq2WzBI5VtA91xVZkEky2Ip1ZWYPZry3DK9N9DqNHRMhrKoBKET/nLLCKHqvVsjt76Gr8uHq0oYjsxuHQ3IhQwK1TEZUu44U6qu6/c4QHQqiBdvWy21+40Gmw83rN+aow4fdKNtYwE9lYRSmiNFLUko7pypRAprzUpv/ZpVNAvx1rFABs1BMcVCpH0iJN52zIs0nC0zAZoljANf1IrffbgFa7rkkx36cgt2YDqEMRw0MCmoZFJQwqSgVKj4vWqs8aJPJQyFSUGMSQnBh9L28YC04VyZrPGCz/gnXPwFstd5EIoAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Table 5\"\n        title=\"\"\n        src=\"/static/86ac8f13599606661a1e8aa06e91fd8b/6a8a8/table5.png\"\n        srcset=\"/static/86ac8f13599606661a1e8aa06e91fd8b/232f7/table5.png 245w,\n/static/86ac8f13599606661a1e8aa06e91fd8b/6a8a8/table5.png 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>spark UI를 통해 JOIN 과정을 살펴보면, 데이터 쏠림이 상당히 완화된 것을 확인할 수 있습니다.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: -70px; margin-right: -70px; text-align: center; max-width: 980px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 72.24489795918367%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACAUlEQVQ4y42S627bMAxG/f6Ptb9rgXUL1jbItfHd8iW2JCuUrG+gHG9pFgwTQMi05YNDUlHbNPTt+Ss+Xl+8khLGjOi6FmmS4P3tDUKIEMMwoK7rEFJKVFWF8/mMruuglIIxJkS0aUb6su/wlCq/KiTexYi10PhZSBwaDedcCO89eE3T9CkH/DUQ3kUH0dMqH/DRau+8Rz8MGM0FbvJQWmNZl8slmLEFL96lHCClgdImVMBnojRNaNQKTS08H+JSz+cOo9bYbDbo+x7WWiRJEqJt22CYZRm22x3SdAVRHpHFaWhB1LYtuWlCmqaeDUZjgrrWGvv9PvzIwDzPQUShZM6F6JAk32HMGt6sMak+VBXVdU1XA8/a3GDOF2BRFCHnfRzHALXWQYgSWfYMrS2s7UBUgmhC1DQNcQm3QM4XIJsthtwSfrZ2Qi1iJMkPKEVwVsJSMQO7rvsncDG8BzbNAXG8gVIjnLvABkP6f0MGz0CaDesdTqcDlNIhn0s2cw8ZwEO5B+52uwclz0AhtgHI52agmIGLYZ7nYcp8YAEej0eUZRly3vme/S65PiBNN9DawDmevIC1N8B7Q95vDfn6sOE85QlVdUIcv4SLzd+Jks8lL4aPesj5nx7a67WpkGVPV8MzLMWw1s+GV4O/DB9NeTYklGWNOF5Bq1c4uwWRBJHFL54DL+u2hDUsAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"일반 JOIN 동작 과정\"\n        title=\"\"\n        src=\"/static/15cf33bed48e38cde128623e23a5d519/2b72d/join2.png\"\n        srcset=\"/static/15cf33bed48e38cde128623e23a5d519/232f7/join2.png 245w,\n/static/15cf33bed48e38cde128623e23a5d519/9319d/join2.png 490w,\n/static/15cf33bed48e38cde128623e23a5d519/2b72d/join2.png 980w,\n/static/15cf33bed48e38cde128623e23a5d519/814a3/join2.png 1470w,\n/static/15cf33bed48e38cde128623e23a5d519/aa454/join2.png 1496w\"\n        sizes=\"(max-width: 980px) 100vw, 980px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>salting을 한마디로 말하면, 새로운 join key를 추가하여 데이터를 더 잘개 쪼개주는 것입니다.\n그 새로운 join key가 소위 소금(<code class=\"language-text\">salt</code>)이며, 데이터를 얼마나 잘게 더 쪼갤지를 결정하는 것이\n소금의 크기(<code class=\"language-text\">salt_size</code>)입니다.</p>\n<p>salting은 마냥 좋기만 한 것은 아닙니다. 데이터가 쏠리는 파티션들이 줄어드는 대신,\n한쪽의 데이터가 소금의 크기 만큼 복제되어야 하기 때문에, 그만큼의 네트워크 및 메모리 추가 소모를 일으킵니다.\n이 때문에, <code class=\"language-text\">salt_size</code>를 적정한 수준으로 결정할 필요가 있습니다.</p>\n<blockquote>\n<p>salting을 한마디로 말하면, 새로운 join key를 추가하여 데이터를 더 잘개 쪼개주는 것입니다.</p>\n</blockquote>\n<h3 id=\"salting-join---심화-버전\"><a href=\"#salting-join---%EC%8B%AC%ED%99%94-%EB%B2%84%EC%A0%84\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Salting Join - 심화 버전</h3>\n<p>앞에서, 적절한 <code class=\"language-text\">salt_size</code>를 설정함으로서 salting은 꽤 효과적으로 동작할 수 있음을 앞에서 확인하였습니다만,\n실무에서 이 적절한 소금 크기를 결정하는 것이 만만치 않은 경우도 있습니다.\n예를 들어, 복제되어야 하는 쪽의 데이터가 매우 클 경우, 아무리 작은 <code class=\"language-text\">salt_size</code>라도 부담스러울 수 있습니다. </p>\n<p>이럴 때는 아예 <code class=\"language-text\">salt_size</code>를 데이터에 맞춰 동적으로 설정함으로써 데이터 복제 부하를 최소화 할 수도 있습니다.\n이런 과정까지를 포함한 심화된 버전의 salting join 코드는 다음과 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">aggregation_limit <span class=\"token operator\">=</span> <span class=\"token number\">10</span>\n\nrunner_count <span class=\"token operator\">=</span> runner<span class=\"token punctuation\">.</span>groupBy<span class=\"token punctuation\">(</span><span class=\"token string\">'city'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">'count'</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> aggregation_limit<span class=\"token punctuation\">)</span>\n\n@F<span class=\"token punctuation\">.</span>udf<span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">.</span>IntegerType<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">salt_size_udf</span><span class=\"token punctuation\">(</span>count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> count <span class=\"token keyword\">is</span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token number\">1</span>\n    \n    div <span class=\"token operator\">=</span> count <span class=\"token operator\">//</span> aggregation_limit\n    rem <span class=\"token operator\">=</span> count <span class=\"token operator\">%</span> aggregation_limit\n\n    <span class=\"token keyword\">if</span> rem <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> div\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> div <span class=\"token operator\">+</span> <span class=\"token number\">1</span>\n\nrunner_3 <span class=\"token operator\">=</span> runner<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>\n    F<span class=\"token punctuation\">.</span>broadcast<span class=\"token punctuation\">(</span>runner_count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> on<span class=\"token operator\">=</span><span class=\"token string\">'city'</span><span class=\"token punctuation\">,</span> how<span class=\"token operator\">=</span><span class=\"token string\">'left'</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'salt_size'</span><span class=\"token punctuation\">,</span> salt_size_udf<span class=\"token punctuation\">(</span><span class=\"token string\">'count'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"salt\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>F<span class=\"token punctuation\">.</span>rand<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> F<span class=\"token punctuation\">.</span>col<span class=\"token punctuation\">(</span><span class=\"token string\">'salt_size'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>cast<span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">.</span>IntegerType<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\n@F<span class=\"token punctuation\">.</span>udf<span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">.</span>ArrayType<span class=\"token punctuation\">(</span>T<span class=\"token punctuation\">.</span>IntegerType<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">salt_array_udf</span><span class=\"token punctuation\">(</span>salt_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">return</span> <span class=\"token builtin\">list</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> salt_size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\ncity_3 <span class=\"token operator\">=</span> city<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>\n    F<span class=\"token punctuation\">.</span>broadcast<span class=\"token punctuation\">(</span>runner_count<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> on<span class=\"token operator\">=</span><span class=\"token string\">'city'</span><span class=\"token punctuation\">,</span> how<span class=\"token operator\">=</span><span class=\"token string\">'left'</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'salt_size'</span><span class=\"token punctuation\">,</span> salt_size_udf<span class=\"token punctuation\">(</span><span class=\"token string\">'count'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>withColumn<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"salt\"</span><span class=\"token punctuation\">,</span> F<span class=\"token punctuation\">.</span>explode<span class=\"token punctuation\">(</span>salt_array_udf<span class=\"token punctuation\">(</span><span class=\"token string\">'salt_size'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span>\n\njoined_3 <span class=\"token operator\">=</span> runner_3<span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>city_3<span class=\"token punctuation\">,</span> on<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'city'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'salt'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> how<span class=\"token operator\">=</span><span class=\"token string\">'left'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>이 코드는 다음과 같은 일을 합니다.</p>\n<ol>\n<li>하나의 JOIN key에 모여드는 데이터의 크기(<code class=\"language-text\">aggregation_limit</code>)를 정합니다.\n여기서는 하나의 key 당 10명의 선수만 모여들게 하겠다는 의미가 됩니다.</li>\n<li>지역별 선수 숫자를 계산하여 <code class=\"language-text\">runner_count</code>에 담습니다.</li>\n<li>지역별 선수 숫자에 따른 소금 크기를 계산해주는 함수(<code class=\"language-text\">salt_size_udf</code>)를 정의합니다.\n이 함수는 기본적으로 선수 숫자를 <code class=\"language-text\">aggregation_limit</code>로 나눕니다.</li>\n<li>선수 데이터에 지역별 선수 숫자 데이터(<code class=\"language-text\">runner_count</code>)를 join하고,\n그것을 이용해 각 선수별 소금 크기(<code class=\"language-text\">salt_size</code>)를 계산한 후,\n그 소금 크기를 이용해 소금(<code class=\"language-text\">salt</code>) 열을 추가합니다.</li>\n<li>지역 데이터에 지역별 선수 숫자 데이터(<code class=\"language-text\">runner_count</code>)를 join하고,\n그것을 이용해 각 지역별 소금 크기(<code class=\"language-text\">salt_size</code>)를 계산한 후,\n그 소금 크기를 이용해 소금(<code class=\"language-text\">salt</code>) 열을 추가합니다.</li>\n</ol>\n<p>최종 join 결과에서 각 지역마다 적절한 <code class=\"language-text\">salt_size</code> 가 사용된 것을 확인할 수 있습니다.</p>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: -70px; margin-right: -70px; text-align: center; max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 32.244897959183675%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB8UlEQVQY0wHmARn+AJS2fj1cblFTd5BoSK3VkzSjwZAvn8OIOpa1gjONrnk/iKR2On+bbUOHpHU8cIdhRqzTkjWYtYYxfJhpSK7Rly6EoHI6lbd+O4+pfTF5lmZFACBMAhgAAwAqBBsAH0SmAgoAFAAEKmcAEQtVAAkeSwAWBS8AEBIzAB0PPQARBR0AHEOnAAoAIAAEG0IAGxOaAAUORAANLWwDEQAjAAYdQAUfAFiDOx4fLhYwPVkpIYXHWRNmlEcOXo0/HGeXRhJVfjkeRWYvGz9eKiVQdzYaNU4kJH+9VRR8tVcMX44/G3OpThBrn0kRaZ1GGFd/PRBDZCwnAGynRBMZJxAlQ2gqFX/EUBBVhDYKV4Y3F1eGNw5GbSwcOVckFzVSISI9XicYJDgXJHOzSRFglT0JRmwsHXGuRwxajDkOYJQ9FUZrLAw6WyUjAFiJOBYTHgwnM08gGX7DTw9TgTUIWIg4FlOBNQ1DaCobOFckFDBLHiI7XSYWIzcWIXu/Tg9OejIJOlslIH3CTwlKcy8QW405FUFlKgs4VyMiAFuPOhwrRBsqPmAnI3W3ShZknUASYJY9G2ScPxRWhzYdUX4zGkVsKyNPfTIcOlokJHGxSBdglj0TR28tJHi8TBFSgDQaYJY8G16TOxNIcC0kT5GIWAbAi6UAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Table 6\"\n        title=\"\"\n        src=\"/static/ac5773d69ba921b947a05df219c5b260/7842b/table6.png\"\n        srcset=\"/static/ac5773d69ba921b947a05df219c5b260/232f7/table6.png 245w,\n/static/ac5773d69ba921b947a05df219c5b260/9319d/table6.png 490w,\n/static/ac5773d69ba921b947a05df219c5b260/7842b/table6.png 800w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  </p>\n<p>이 코드에서 두 가지만 추가로 언급하겠습니다.</p>\n<p>첫번째로, <code class=\"language-text\">runner_count</code>를 생성하는 코드 뒤에 달린 <code class=\"language-text\">filter</code> 구문입니다.\n이것은 지역별 선수 숫자 전체 데이터 에서 필요한 부분만 뽑아내서 크기를 줄임으로써,\n뒤에 <code class=\"language-text\">runner_3</code>과 <code class=\"language-text\">city_3</code>에 join 될 때 broadcast join 방식이 가능하게 해 줍니다.\n<code class=\"language-text\">salt_size_udf</code>는 널(null, None)일 경우 소금 크기를 최소(1)로 리턴하는 점을 이용한 것입니다.\n그런데, 이런 방법을 일반적으로 아무 데이터에서나 사용할 수 있을까요?\n이렇게 필터링한다고 항상 broadcast를 해도 될만큼 데이터가 작아질 수 있을까요?\n답은 거의 대부분 그렇다 입니다. 쏠림이 발생하는 데이터는 대부분 그 분포가 파레토 법칙(Pareto Principle)을\n따르기 때문입니다. 적절한 수준의 <code class=\"language-text\">aggregation_limit</code>가 주어질 경우,\nkey 카운팅 데이터는 원래 데이터 숫자 대비 로그스케일(Logscale)로 줄어들 수 있습니다.\n개 수를 로그스케일로 줄여도 수백만이 되는 데이터는 현재 거의 없다고 봐도 무방합니다.</p>\n<p>두번째로 언급할 것은 <code class=\"language-text\">runner_count</code>가 꼭 정확할 필요가 없다는 것입니다.\n대략적인 패턴만 유지된다면, 과거 데이터를 기반으로 미리 계산해 놓은 것을 써도 별 문제가 안됩니다.\n데이터 파이프라인 상에서 자주 실행되는 앱(application)의 경우,\n카운팅 과정만 따로 떼어내서 그 빈도를 낮춰줌으로써, 추가적인 최적화가 가능합니다.</p>\n<h3 id=\"맺음말\"><a href=\"#%EB%A7%BA%EC%9D%8C%EB%A7%90\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>맺음말</h3>\n<p>이 글에서는 salting join 기법에 대해 살펴 보았습니다.\nsalting 기법은 데이터 쏠림이 발생하여 문제가 되는 상황을 해결하기 위한 기법으로, 기본적으로는\n새로운 join key를 추가하여 데이터를 더 잘개 쪼개주는 것입니다. 이 새로운 join key를 소금(<code class=\"language-text\">salt</code>)이라고 부르며,\n일정 법위의 정수 값 입니다. 이 값을 어떤식으로 뿌려줄 것인가에 따라 다양한 최적화가 가능합니다.</p>","excerpt":"이 글에서는 salting 기법을 기본 버전, 심화 버전의 pyspark 코드로 보여드립니다. 데이터 엔지니어링 과정에서 두 개 이상의 데이터를 JOIN 할 때 특정 키(key…","tableOfContents":"<ul>\n<li><a href=\"/20220130-dev-notes-008-salting-method-and-examples/#%EC%8F%A0%EB%A6%BC%EC%9D%B4-%EB%B0%9C%EC%83%9D%ED%95%98%EB%8A%94-%EB%8D%B0%EC%9D%B4%ED%84%B0\">쏠림이 발생하는 데이터</a></li>\n<li><a href=\"/20220130-dev-notes-008-salting-method-and-examples/#%EC%9D%BC%EB%B0%98-join\">일반 Join</a></li>\n<li><a href=\"/20220130-dev-notes-008-salting-method-and-examples/#salting-join---%EA%B8%B0%EB%B3%B8-%EB%B2%84%EC%A0%84\">Salting Join - 기본 버전</a></li>\n<li><a href=\"/20220130-dev-notes-008-salting-method-and-examples/#salting-join---%EC%8B%AC%ED%99%94-%EB%B2%84%EC%A0%84\">Salting Join - 심화 버전</a></li>\n<li><a href=\"/20220130-dev-notes-008-salting-method-and-examples/#%EB%A7%BA%EC%9D%8C%EB%A7%90\">맺음말</a></li>\n</ul>","fields":{"slug":"/20220130-dev-notes-008-salting-method-and-examples/","github":"","playstore":"","appstore":"","link":"","linkDesc":""},"frontmatter":{"author":{"id":"권순목","name":"권순목","bio":"서비스개발본부 데이터사이언스실의 실장을 담당하고 있습니다.","avatar":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/9ed24df5bc4da5ffb8999eece711ff11/a2408/soonmok.kwon.png"}}]}},"date":"2022-01-30","title":"Salting 기법 예제 코드","tags":["DataScience","DataEngineering","Salting","ExampleCode","Pyspark"],"titleImage":{"childImageSharp":{"resize":{"src":"/static/93049f3313f9c628f7f3cdc4d9a5a545/d8255/title.jpg"}}}}}},"pageContext":{"slug":"/20220130-dev-notes-008-salting-method-and-examples/"}},"staticQueryHashes":["1963140206"]}