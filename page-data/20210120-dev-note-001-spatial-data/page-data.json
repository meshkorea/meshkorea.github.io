{"componentChunkName":"component---src-templates-post-tsx","path":"/20210120-dev-note-001-spatial-data/","result":{"data":{"site":{"siteMetadata":{"title":"MESH KOREA | VROONG í…Œí¬ ë¸”ë¡œê·¸","description":"ë©”ì‰¬ì½”ë¦¬ì•„ì—ì„œ ê¸°ìˆ , ìœ ì € ê²½í—˜ ë° ê³µê°„ ë””ìì¸, ì„œë¹„ìŠ¤ ê¸°íš ë“± ë¬¼ë¥˜í”Œë«í¼ì„ ë§Œë“¤ê¸° ìœ„í•œ ê³¼ì •ì— ëŒ€í•œ ê³ ë¯¼ê³¼ ê·¸ í•´ê²°ì„ ë‹´ì€ ë¸”ë¡œê·¸ì…ë‹ˆë‹¤."}},"markdownRemark":{"html":"<p>ì•ˆë…•í•˜ì„¸ìš”. ë©”ì‰¬ì½”ë¦¬ì•„ ê¸°ë°˜ì„œë¹„ìŠ¤ì„œë²„íŒ€ ê°•ì„±ì¼ì…ë‹ˆë‹¤.\nì´ë²ˆì— Spatial dataë¥¼ <strong>10,000ë°°!</strong> ì˜ ë‹¤ë£¨ê²Œ ëœ ë°©ë²•ì— ëŒ€í•´ ê³µìœ í•˜ê³ ì ê¸€ì„ ì“°ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ˜€</p>\n<p>ë“¤ì–´ê°€ê¸°ì— ì•ì„œ, <strong>ë©”ì‰¬ì½”ë¦¬ì•„</strong>ëŠ” ìŒì‹, í™”ì¥í’ˆ, í¸ì˜ì  ìƒí’ˆê³¼ ê°™ì€ ìƒí’ˆì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ë°°ì†¡í•˜ëŠ” ì„œë¹„ìŠ¤ì¸ ìŠ¤ë§ˆíŠ¸ ë¬¼ë¥˜ í”Œë«í¼ <strong>ë¶€ë¦‰(Vroong)</strong> ğŸš› ì„ ìš´ì˜í•˜ëŠ” íšŒì‚¬ì¸ë°ìš”.</p>\n<p>ë°°ì†¡ ì£¼ë¬¸ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ì„œëŠ”</p>\n<ul>\n<li>ìƒì ê³¼ ê³ ê° ì‚¬ì´ì˜ ê±°ë¦¬ì™€ ì¥ì• ë¬¼ ë“±ì„ ê³ ë ¤í•˜ì—¬ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ì£¼ë¬¸ê±´ì¸ê°€?</li>\n<li>ê¸°ì‚¬ë‹˜ê»˜ëŠ” ì–¼ë§ˆë§Œí¼ì˜ ê¸ˆì•¡ì„ ì§€ë¶ˆí•´ì•¼ í•˜ëŠ”ê°€?</li>\n<li>ìƒì ì—ì„œëŠ” ì–¼ë§ˆë§Œí¼ì˜ ê¸ˆì•¡ì„ ë°›ì•„ë‚´ì•¼ í•˜ëŠ”ê°€?</li>\n</ul>\n<p>ë¥¼ íŒë‹¨í•´ì•¼ í•©ë‹ˆë‹¤.</p>\n<p>ê·¸ë˜ì„œ <strong>spatial data</strong>ë¥¼ ì´ìš©í•˜ì—¬ ê° ìƒì ì˜ ë°°ì†¡ ê°€ëŠ¥í•œ ê¶Œì—­ë“¤, ë°°ì†¡ì´ ë¶ˆê°€ëŠ¥í•œ ê¶Œì—­ë“¤ì„ ê´€ë¦¬í•˜ëŠ” ê¶Œì—­ ì‹œìŠ¤í…œì„ ìš´ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤.</p>\n<p>ê¶Œì—­ ì‹œìŠ¤í…œì—ì„œëŠ” <strong>spatial data</strong>ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ë‹¤ë£¨ê¸° ìœ„í•´ì„œ <strong>PostgreSQL</strong>ì—ì„œ ì§€ì›í•˜ëŠ” <strong>PostGIS</strong>ë¥¼ ì´ìš©í•˜ê³  ìˆëŠ”ë°ìš”.\n<strong>ì§€ë„ í™”ë©´ì—ì„œ ë³´ì´ëŠ” ì˜ì—­ê³¼ í–‰ì •ë™/ë²•ì •ë™ polygonì˜ intersectsë¥¼ ê³„ì‚°í•˜ê³  polygonì„ ê°€ì ¸ì˜¤ëŠ” ê³¼ì •ì—ì„œ í° ì„±ëŠ¥ ì´ìŠˆë¥¼ ê°€ì§€ê³  ìˆì—ˆìŠµë‹ˆë‹¤.</strong> <em>(worst caseì—ì„œëŠ” ì¡°íšŒì‹œê°„ì´ 60ì´ˆ ì •ë„ ê±¸ë ¸ìŠµë‹ˆë‹¤â€¦ëˆˆë¬¼ ğŸ˜¢ )</em></p>\n<p>ì„±ëŠ¥ì´ ë–¨ì–´ì§€ëŠ” ë¬¸ì œì˜ ì¿¼ë¦¬ëŠ” ì•„ë˜ì™€ ê°™ì•˜ìŠµë‹ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">SELECT region.*\nFROM region\nINNER JOIN address_polygon on region.pk=address_polygon.region_pk\nINNER JOIN address on address_polygon.address_pk=address.pk\nWHERE address.address_type = &#39;LEGAL&#39;\nAND region.region_type = &#39;ADDRESS_REGION&#39;\nAND region.status = &#39;ENABLED&#39;\nAND st_intersects(\n    region.polygon,\n    ST_MakeEnvelope(126.9373539, 37.5210172, 127.0540836, 37.5873607, 4326)\n);</code></pre></div>\n<p><strong>[ì¿¼ë¦¬1]</strong></p>\n<p>ê·¸ëŸ¼ ì´ ë¬¸ì œë¥¼ ì–´ë–»ê²Œ í•´ê²°í–ˆëŠ”ì§€, <strong>ì–´ë–»ê²Œ ì„±ëŠ¥ì„ 10,000ë°° ì˜¬ë¦´ ìˆ˜ ìˆì—ˆëŠ”ì§€</strong> ì§€ê¸ˆë¶€í„° ì´ì•¼ê¸°í•´ë³´ê² ìŠµë‹ˆë‹¤!</p>\n<h2 id=\"spatial-dataì˜-intersectsì˜-ê³„ì‚°-ë°©ë²•\"><a href=\"#spatial-data%EC%9D%98-intersects%EC%9D%98-%EA%B3%84%EC%82%B0-%EB%B0%A9%EB%B2%95\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Spatial dataì˜ intersectsì˜ ê³„ì‚° ë°©ë²•</h2>\n<p>ë¬¸ì œ ìƒí™©ì—ì„œ ì‚¬ìš©í•˜ëŠ” spatial dataëŠ” 2dì˜ polygon ì…ë‹ˆë‹¤. ê·¸ë¦¬ê³  intersectsëŠ” ë‘ê°œì˜ polygonì´ ê²¹ì¹˜ëŠ”ì§€ë¥¼ íŒë‹¨í•˜ëŠ”\nì—°ì‚°ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì´ë¥¼ postgresqlì—ì„œëŠ” ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> region <span class=\"token keyword\">WHERE</span> region\n<span class=\"token operator\">AND</span> st_intersects<span class=\"token punctuation\">(</span>\n    region<span class=\"token punctuation\">.</span><span class=\"token keyword\">polygon</span><span class=\"token punctuation\">,</span>\n    ST_MakeEnvelope<span class=\"token punctuation\">(</span><span class=\"token number\">126.9373539</span><span class=\"token punctuation\">,</span> <span class=\"token number\">37.5210172</span><span class=\"token punctuation\">,</span> <span class=\"token number\">127.0540836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">37.5873607</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4326</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><strong>[ì¿¼ë¦¬2]</strong></p>\n<p>ìœ„ ì¿¼ë¦¬ëŠ” region í…Œì´ë¸”ì˜ polygon ì»¬ëŸ¼ê³¼ ì„œìš¸ ì¢…ë¡œêµ¬ ë¶€ê·¼ì˜ ì˜ì—­ì„ ë¹„êµí•˜ì—¬ â€˜ê²¹ì¹˜ëŠ” ì˜ì—­ì´ ìˆëŠ”ê°€â€™ë¥¼ ì¡°ê±´ìœ¼ë¡œ\nselect í•˜ëŠ”ë°ìš”. ì•½ ì²œë§Œê°œì˜ rowê°€ ìˆëŠ” region í…Œì´ë¸”ì—ì„œë„ 0.5ì´ˆë‚´ì™¸ì˜ ì„±ëŠ¥ì„ ë³´ì—¬ì£¼ë©´ì„œ ì˜ì™¸ë¡œ ë¹ ë¥¸ ì„±ëŠ¥ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.\nintersects ì—°ì‚°ì´ ë‹¨ìˆœí•˜ê²Œ ìƒê°í•˜ë©´ ë¬´ê±°ìš´ ì—°ì‚°ì¼ê±°ë¼ ì¶”ì¸¡í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ì´ ì¿¼ë¦¬ê°€ ì–´ë–»ê²Œ ë¹ ë¥´ê²Œ ë™ì‘í•  ìˆ˜ ìˆëŠ” ê²ƒì¸ì§€\nì˜ë¬¸ì´ ë“œëŠ”ë°, ê°€ëŠ¥í•œ ë°©ë²•ì´ ìˆìŠµë‹ˆë‹¤. ë°”ë¡œ <a href=\"https://en.wikipedia.org/wiki/R-tree\">R-Tree</a>ë¼ëŠ” ìë£Œêµ¬ì¡°ë¥¼ ì‚¬ìš©í•œ\nindex êµ¬ì¡°ë¥¼ í†µí•´ ê³„ì‚°í•˜ë©´ intersects ê³„ì‚°ì„ ë¹ ë¥´ê²Œ í•  ìˆ˜ ìˆë‹¤ê³  í•©ë‹ˆë‹¤.</p>\n<p>R-treeì˜ ì¸ë±ì‹± ë°©ë²•ì€ B-treeì™€ ìœ ì‚¬í•œë°, polygon ë°ì´í„°ë“¤ì˜ ìµœì†Œí•œì˜ bounding boxë¥¼ êµ¬í•˜ê³  ê·¸ ë°•ìŠ¤ ê°„ì˜ í¬í•¨ê´€ê³„ë¥¼\nB-treeì˜ í˜•ì‹ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” index treeì…ë‹ˆë‹¤. ì´ë ‡ê²Œ B-treeì˜ ë²”ìœ„ ì¡°íšŒì™€ ê°™ì€ ê³„ì‚° ë°©ë²•ìœ¼ë¡œ ê³„ì‚°í•˜ë©´ í¬í•¨ê´€ê³„ì™€\nêµì°¨ê´€ê³„(intersects)ë¥¼ ì‰½ê²Œ ê³„ì‚°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. index searchë¥¼ í†µí•´ì„œ ëŒ€ì¶© intersectsí•˜ëŠ” polygonì„ bounding boxê°€\nì•„ë‹Œ ì‹¤ì œ polygonê³¼ì˜ intersects ì—°ì‚°ì„ í•œë²ˆ ë” ì§„í–‰í•´ì„œ, ì§„ì§œ ì›í•˜ëŠ” polygonì´ ë§ëŠ”ì§€ í•œë²ˆ ë” ì„ ë³„ê³¼ì •ì„ ê±°ì¹©ë‹ˆë‹¤.</p>\n<p><img src=\"https://upload.wikimedia.org/wikipedia/commons/6/6f/R-tree.svg\"></p>\n<p>ì´ ê¶Œì—­ ì„œë¹„ìŠ¤ëŠ” ì²˜ìŒë¶€í„° í”„ë¡œì íŠ¸ì— involveëœê²Œ ì•„ë‹ˆì—ˆê¸° ë•Œë¬¸ì— ìœ„ ë¬¸ì œì˜ ì¿¼ë¦¬1ì„ ë§Œë‚¬ì„ë•ŒëŠ”\nì¿¼ë¦¬2ë¥¼ í…ŒìŠ¤íŠ¸ í•´ë³´ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì²œë§Œê°œì˜ rowì— ëŒ€í•´ intersectsë¥¼ ëª¨ë‘ ê³„ì‚°í•œë‹¤ê³  ìƒê°í–ˆê¸° ë•Œë¬¸ì—, ì–´ë–»ê²Œ í•´ë„\në¹ ë¥´ê²Œ í•  ìˆ˜ ìˆëŠ” ë°©ë²•ì´ ì—†ë‹¤ê³  ìƒê°í–ˆì£ . ë”°ë¼ì„œ ëª¨ë“  í´ë¦¬ê³¤ì„ ë©”ëª¨ë¦¬ì— ì˜¬ë¦¬ê³  ìµœì í™”ëœ ì•Œê³ ë¦¬ì¦˜ì„ êµ¬í˜„í•´ì•¼ê² ë‹¤ëŠ”\nìƒê°ì„ í•˜ë©´ì„œ ì°¾ì•„ë³´ë‹¤ê°€ R-treeì— ëŒ€í•´ì„œ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.\nR-tree ì„±ëŠ¥ì— ëŒ€í•´ì„œ Pythonìœ¼ë¡œ êµ¬í˜„í•´ë³´ê³  ì¶©ë¶„íˆ ë¹ ë¥¸ ê²ƒì„ í™•ì¸í•˜ì˜€ìŠµë‹ˆë‹¤. Pythonì—ì„œëŠ” R-treeì˜ êµ¬í˜„ì„\nctypesë¥¼ ì´ìš©í•´ libspatialindexë¥¼ ë˜í•‘í•œ <a href=\"https://pypi.org/project/Rtree/\">ë¼ì´ë¸ŒëŸ¬ë¦¬</a>ë¥¼ ì°¾ì„ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>\n<p>ê·¸ë˜ì„œ â€˜PostGISëŠ” ì´ëŸ° ê²ƒì„ ì§€ì› ì•ˆí•˜ë‚˜?â€™ ì‹¶ì–´ì„œ ì°¾ì•„ë³´ê²Œ ë˜ì—ˆëŠ”ë° PostGISë„ R-treeì™€ ê°™ì€ bounding box indexingì„ ì§€ì›í•œë‹¤ëŠ”\nê²ƒì„ ì•Œê²Œ ë˜ì—ˆê³ , ì‹¬ì§€ì–´ í•´ë‹¹ ì¸ë±ì‹±ì´ ìœ„ì˜ ì¿¼ë¦¬ì— <code class=\"language-text\">polygon</code> ì»¬ëŸ¼ì— ì ìš©ë˜ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.</p>\n<p>ì •í™•íˆëŠ” PostGISëŠ” R-Treeë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©í•˜ì§€ ì•Šê³  <a href=\"https://postgis.net/workshops/postgis-intro/indexing.html\">GIST</a>\në¼ëŠ” ì´ë¦„ìœ¼ë¡œ index ë°©ë²•ì„ ì œê³µí•˜ê³  ìˆëŠ”ê²ƒì„ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  ìœ„ GISTì˜ ë§í¬ë¥¼ ì½ì–´ë³´ë©´ ë‚˜ì™€ ìˆëŠ”ë°,\nbounding boxê°„ì˜ ì—°ì‚°ì„ ìœ„í•´ì„œ postgresqlì—ì„œëŠ” <a href=\"https://postgis.net/docs/reference.html#idm9871\">íŠ¹ìˆ˜í•œ ì—°ì‚°ì</a>ë¥¼ ë”°ë¡œ\nì§€ì›í•˜ê³  ìˆìŠµë‹ˆë‹¤. ë˜í•œ st_intersectsëŠ” ì´ë¯¸ ë‚´ë¶€ì—ì„œ <code class=\"language-text\">&amp;&amp;</code> ì—°ì‚°ìë¥¼ í†µí•´ì„œ bounding boxê°„ì˜ ì—°ì‚°ì„ í•˜ê³  <code class=\"language-text\">AND</code> ì¡°ê±´ìœ¼ë¡œ\nì‹¤ì œ polygonì´ intersects í•˜ëŠ” ê°€ë¥¼ íŒë‹¨í•œë‹¤ëŠ” ê²ƒì„ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ ì‚¬ì‹¤ì„ ì•Œê³  ìœ„ ì¿¼ë¦¬ 2ë¥¼ ì‘ì„±í•˜ì—¬ ì¿¼ë¦¬í•´ë³´ê³ ,\n0.5ì´ˆì˜ ì„±ëŠ¥ì´ë©´ 1ë¶„ì— ë¹„í•´ì„œëŠ” êµ‰ì¥íˆ ì¢‹ì€ ì„±ëŠ¥ì´ ë‚˜ì˜¨ë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì–´ë–»ê²Œ ì´ ì •ë„ì˜ ì°¨ì´ë¥¼ ê°–ê²Œ ë˜ëŠ”ì§€\nì¢€ ë” ì •í™•íˆ ì•Œì•„ë³´ê³ ì <code class=\"language-text\">explain analyze</code>ë¥¼ í•´ë³´ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Index Scan using polygon_geom_idx on region  (cost=0.42..513509.60 rows=... width=...) (actual time=0.136..515.878 rows=... loops=1)\n    Index Cond: (polygon &amp;&amp; &#39;...&#39;::geometry)\n    Filter: _st_intersects(polygon, &#39;...&#39;::geometry)\n    Rows Removed by Filter: 383\nPlanning Time: 0.244 ms\nExecution Time: 522.464 ms</code></pre></div>\n<p>ìœ„ explain ê²°ê³¼ë¥¼ ë³´ë©´ index conditionìœ¼ë¡œ <code class=\"language-text\">polygon</code> column ê³¼ <code class=\"language-text\">&amp;&amp;</code> ì—°ì‚°ì„ í†µí•´ì„œ bounding boxë¥¼ ì£¼ì–´ì§„\npolygon ë°ì´í„°ì™€ ë¹„êµí•˜ê³ , í›„ì— filter ì¡°ê±´ìœ¼ë¡œ <code class=\"language-text\">_st_intersects</code>ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>\n<h2 id=\"ê·¸ëŸ¬ë©´-ë¬¸ì œëŠ”-ì–´ë””ì„œ-ë°œìƒí•˜ëŠ”ê±¸ê¹Œ\"><a href=\"#%EA%B7%B8%EB%9F%AC%EB%A9%B4-%EB%AC%B8%EC%A0%9C%EB%8A%94-%EC%96%B4%EB%94%94%EC%84%9C-%EB%B0%9C%EC%83%9D%ED%95%98%EB%8A%94%EA%B1%B8%EA%B9%8C\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ê·¸ëŸ¬ë©´ ë¬¸ì œëŠ” ì–´ë””ì„œ ë°œìƒí•˜ëŠ”ê±¸ê¹Œ?</h2>\n<p>ê·¸ë ‡ë‹¤ë©´ â€˜ë¬¸ì œê°€ ëœ ì¿¼ë¦¬ 1ì€ ë„ëŒ€ì²´ ë¬´ìŠ¨ ë¬¸ì œê°€ ìˆì—ˆë˜ ê±´ê°€?â€™ ì‹¶ì–´ì„œ í•´ë‹¹ ì¿¼ë¦¬ë„ <code class=\"language-text\">explain analyze</code>ë¥¼ ëŒë ¤ë³´ì•˜ìŠµë‹ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Gather  (cost=1080.01..67698.36 rows=... width=1894) (actual time=117.101..66590.220 rows=... loops=1)\n  Workers Planned: 1\n  Workers Launched: 1\n  -&gt;  Nested Loop  (cost=80.01..66697.06 rows=8 width=1894) (actual time=66.379..65641.273 rows=134 loops=2)\n        -&gt;  Nested Loop  (cost=79.58..51221.10 rows=1996 width=8) (actual time=63.748..5975.698 rows=401872 loops=2)\n              -&gt;  Parallel Bitmap Heap Scan on address  (cost=79.14..10717.49 rows=1714 width=8) (actual time=57.163..61.659 rows=2526 loops=2)\n                    Recheck Cond: ((address_type)::text = &#39;LEGAL&#39;::text)\n                    Heap Blocks: exact=107\n                    -&gt;  Bitmap Index Scan on address_address_type_index  (cost=0.00..78.42 rows=2914 width=0) (actual time=100.710..100.710 rows=5504 loops=1)\n                          Index Cond: ((address_type)::text = &#39;LEGAL&#39;::text)\n              -&gt;  Index Only Scan using address_polygon_pkey on address_polygon  (cost=0.43..23.23 rows=40 width=16) (actual time=0.579..2.307 rows=159 loops=5052)\n                    Index Cond: (address_pk = address.pk)\n                    Heap Fetches: 304308\n        -&gt;  Index Scan using region_primary_key on region  (cost=0.43..7.75 rows=1 width=1894) (actual time=0.147..0.147 rows=0 loops=803744)\n              Index Cond: (pk = address_polygon.region_pk)\n              Filter: ((optimized_polygon_30 &amp;&amp; &#39;...&#39;::geometry) AND ((region_type)::text = &#39;ADDRESS_REGION&#39;::text) AND ((status)::text = &#39;ENABLED&#39;::text) AND _st_intersects(optimized_polygon_30, &#39;...&#39;::geometry)\n              Rows Removed by Filter: 1\nPlanning Time: 3.403 ms\nExecution Time: 66590.472 ms</code></pre></div>\n<p>í•´ë‹¹ ì¿¼ë¦¬ë¥¼ ì‚´í´ë³´ë©´ polygonì˜ indexë¥¼ íƒ€ì§€ ì•Šê³  ì¿¼ë¦¬ê°€ ë˜ëŠ” ê±¸ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ë‹¤ì–‘í•œ ë°©ë²•ìœ¼ë¡œ í•´ë‹¹ ì¿¼ë¦¬ë¥¼ ì‹œë„í•´ë´¤ëŠ”ë°,\nê±°ì˜ ëŒ€ë¶€ë¶„ <code class=\"language-text\">address_address_type_index</code>ë¥¼ íƒ€ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤. ì™œ ê·¸ëŸ°ì§€ ì´ìœ ë¥¼ ì°¾ì•„ë³´ê³  ì‹¶ì—ˆì§€ë§Œ ëª…í™•í•˜ê²Œ\nì•Œ ìˆ˜ ìˆëŠ” ë°©ë²•ì€ ì—†ì—ˆê³ , ì¶”ë¡ í•  ìˆ˜ ìˆëŠ” ê·¼ê±°ë“¤ì— ëŒ€í•´ì„œëŠ” ëª‡ ê°€ì§€ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ê°€ì¥ íƒ€ë‹¹í•˜ë‹¤ê³  ìƒê°ë˜ëŠ” ê·¼ê±°ëŠ”\nìœ„ <a href=\"https://postgis.net/workshops/postgis-intro/indexing.html#analyzing\">Spartial indexing</a>ì— ëŒ€í•œ documentì—ì„œ í™•ì¸í• \nìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤.</p>\n<blockquote>\n<p>it is not always faster to do an index search: if the search is going to return every record\nin the table, traversing the index tree to get each record will actually be slower than just sequentially reading\nthe whole table from the start.</p>\n</blockquote>\n<p>postgresqlì´ ê²½ìš°ì— ë”°ë¼ì„œ indexë¥¼ íƒ€ëŠ” ê²ƒì´ ë¹„íš¨ìœ¨ì ì´ë¼ íŒë‹¨ë˜ë©´ í’€ì„œì¹˜í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ optimizeí•˜ëŠ”ê±¸ ì•Œê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.\nì–´ë–¤ ê¸°ì¤€ìœ¼ë¡œ í•˜ëŠ”ì§€ê°€ ë¶ˆëª…í™•í•˜ê³  vacuuming í•´ë„ indexë¥¼ ì‚¬ìš©í•  ë•Œë„ ìˆê³  ì•ˆ í•  ë•Œë„ ìˆì–´ì„œ ë‹¨ìˆœíˆ vacuumingìœ¼ë¡œëŠ” ì¼ê´€ì ì¸\nì„±ëŠ¥ì„ ë³´ì¥í•˜ê¸°ëŠ” ì–´ë µë‹¤ê³  íŒë‹¨í–ˆìŠµë‹ˆë‹¤.</p>\n<p>ìœ„ì— regionì˜ í…Œì´ë¸”ì´ ì•½ ì²œë§Œê°œì˜ rowê°€ ìˆëŠ”ë° ì‹¤ì œë¡œ ê·¸ì¤‘ í–‰ì •ë™/ë²•ì •ë™ê³¼ ì‹œêµ°êµ¬, ì‹œë„ì˜ ëª¨ë“  í´ë¦¬ê³¤ì„ 58,000ê°œ ì •ë„ ë°–ì— ì•ˆë¼ì„œ postgresqlì´ <code class=\"language-text\">spatial index</code>ë¥¼ íƒ€ëŠ”ê²Œ ì´ë“ì´ ë  ìˆ˜ ìˆë‹¤ íŒë‹¨í•  ìˆ˜ ìˆë„ë¡ row ìˆ˜ë¥¼ ì¤„ì´ê³ , joinì„ í’€ì–´ì„œ\n<code class=\"language-text\">spatial index</code>ì™€ <code class=\"language-text\">address_type index</code>ë¥¼ ë³‘ë ¬ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•˜ê¸° ìœ„í•´ì„œ tableì„ í•©ì¹ ê¹Œ ìƒê°í•˜ë˜ ì¤‘\n<a href=\"https://en.wikipedia.org/wiki/Materialized_view\">materialized view</a>ë¥¼ ë– ì˜¬ë¦¬ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.</p>\n<p>oracle, postgresql, mariadb ì—ì„œëŠ” ì¼ë°˜ì ì¸ viewì™€ëŠ” ë‹¬ë¦¬ ë¬¼ë¦¬ì ìœ¼ë¡œ ì–´ëŠ ì •ë„ì˜ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  viewì˜ columnì—\nindexë¥¼ ì ìš©í•  ìˆ˜ ìˆëŠ” materialized viewë¥¼ ì§€ì›í•©ë‹ˆë‹¤. join ì¡°ê±´ì„ materialized viewë¡œ ë§Œë“¤ì–´ì„œ ìµœì í™”í•˜ê³ \n<code class=\"language-text\">polygon</code> ì»¬ëŸ¼ì— indexë¥¼ ì ìš© ì‹œì¼œì¤€ë‹¤ë©´ spatial index ì‚¬ì´ì¦ˆê°€ ì‘ì•„ì§€ë©´ì„œ postgresqlì´ cost\nê³„ì‚°ì„ ë” ì˜ í•  ìˆ˜ ìˆì„ê±°ë¼ ì¶”ì¸¡í•´ì„œ ì•„ë˜ì™€ ê°™ì´ ì ìš©í•´ë´¤ìŠµë‹ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> MATERIALIZED <span class=\"token keyword\">VIEW</span> address_region_view <span class=\"token keyword\">AS</span>\n<span class=\"token keyword\">SELECT</span> ap<span class=\"token punctuation\">.</span>region_pk<span class=\"token punctuation\">,</span> region<span class=\"token punctuation\">.</span><span class=\"token keyword\">polygon</span><span class=\"token punctuation\">,</span> ap<span class=\"token punctuation\">.</span>address_type <span class=\"token keyword\">FROM</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">SELECT</span> address_polygon<span class=\"token punctuation\">.</span>region_pk<span class=\"token punctuation\">,</span> address<span class=\"token punctuation\">.</span>address_type <span class=\"token keyword\">FROM</span> address\n    <span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> address_polygon <span class=\"token keyword\">ON</span> address<span class=\"token punctuation\">.</span>pk <span class=\"token operator\">=</span> address_polygon<span class=\"token punctuation\">.</span>address_pk\n    <span class=\"token keyword\">WHERE</span> address<span class=\"token punctuation\">.</span>address_type <span class=\"token operator\">IN</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'LEGAL'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span> ap\n<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> region <span class=\"token keyword\">ON</span> region<span class=\"token punctuation\">.</span>pk <span class=\"token operator\">=</span> ap<span class=\"token punctuation\">.</span>region_pk\n<span class=\"token keyword\">WHERE</span> region<span class=\"token punctuation\">.</span>region_type <span class=\"token operator\">=</span> <span class=\"token string\">'ADDRESS_REGION'</span>\n<span class=\"token operator\">AND</span> region<span class=\"token punctuation\">.</span><span class=\"token keyword\">status</span> <span class=\"token operator\">=</span> <span class=\"token string\">'ENABLED'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">INDEX</span> address_region_view_idx <span class=\"token keyword\">ON</span> address_region_view <span class=\"token keyword\">using</span> gist<span class=\"token punctuation\">(</span><span class=\"token keyword\">polygon</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">INDEX</span> address_region_view_address_type_idx <span class=\"token keyword\">ON</span> address_region_view <span class=\"token punctuation\">(</span>address_type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ì¿¼ë¦¬1ì˜ ì¡°ê±´ì„ viewë¡œ ë…¹ì—¬ë‚´ê³  indexë¥¼ ì ìš©í•œ <code class=\"language-text\">address_region_view</code>ë¥¼ í†µí•´ì„œ ê°™ì€ ê²°ê³¼ê°€ ë‚˜ì™€ì•¼í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ì¬êµ¬ì„±í•˜ì—¬\nexplainì„ í†µí•´ ì„±ëŠ¥ì„ ì¸¡ì •í•´ë´¤ìŠµë‹ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> region<span class=\"token punctuation\">.</span><span class=\"token operator\">*</span>\n<span class=\"token keyword\">FROM</span> address_region_view\n<span class=\"token keyword\">LEFT</span> <span class=\"token keyword\">JOIN</span> region <span class=\"token keyword\">ON</span> region<span class=\"token punctuation\">.</span>pk <span class=\"token operator\">=</span> address_region_view<span class=\"token punctuation\">.</span>region_pk\n<span class=\"token keyword\">WHERE</span> address_region_view<span class=\"token punctuation\">.</span>address_type<span class=\"token operator\">=</span><span class=\"token string\">'LEGAL'</span>\n    <span class=\"token operator\">AND</span> st_intersects<span class=\"token punctuation\">(</span>\n        address_region_view<span class=\"token punctuation\">.</span><span class=\"token keyword\">polygon</span><span class=\"token punctuation\">,</span>\n        ST_MakeEnvelope<span class=\"token punctuation\">(</span><span class=\"token number\">126.9373539</span><span class=\"token punctuation\">,</span> <span class=\"token number\">37.5210172</span><span class=\"token punctuation\">,</span> <span class=\"token number\">127.0540836</span><span class=\"token punctuation\">,</span> <span class=\"token number\">37.5873607</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4326</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>ìœ„ ì¿¼ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ explain í•´ë³´ë©´ ê²°ê³¼ëŠ” ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Nested Loop Left Join  (cost=166.64..825.34 rows=32 width=1533) (actual time=1.660..6.270 rows=... loops=1)\n  -&gt;  Bitmap Heap Scan on address_region_view  (cost=166.21..554.86 rows=32 width=8) (actual time=1.645..5.412 rows=... loops=1)\n        Recheck Cond: ((polygon &amp;&amp; &#39;...&#39;::geometry) AND ((address_type)::text = &#39;LEGAL&#39;::text))\n        Filter: _st_intersects(polygon, &#39;...&#39;::geometry)\n        Rows Removed by Filter: 2\n        Heap Blocks: exact=270\n        -&gt;  BitmapAnd  (cost=166.21..166.21 rows=95 width=0) (actual time=1.573..1.573 rows=0 loops=1)\n              -&gt;  Bitmap Index Scan on address_region_view_idx  (cost=0.00..52.81 rows=1137 width=0) (actual time=0.488..0.488 rows=1281 loops=1)\n                    Index Cond: (polygon &amp;&amp; &#39;...&#39;::geometry)\n              -&gt;  Bitmap Index Scan on address_region_view_address_type_idx  (cost=0.00..113.14 rows=4896 width=0) (actual time=1.003..1.003 rows=5048 loops=1)\n                    Index Cond: ((address_type)::text = &#39;LEGAL&#39;::text)\n  -&gt;  Index Scan using region_primary_key on region  (cost=0.43..8.45 rows=1 width=1533) (actual time=0.003..0.003 rows=1 loops=...)\n        Index Cond: (pk = address_region_view.region_pk)\nPlanning Time: 0.686 ms\nExecution Time: 6.408 ms</code></pre></div>\n<p>ì´ ì‹¤í–‰ì‹œê°„ì´ 66,590msì—ì„œ 6.4msì— ê°€ê¹ê²Œ ì¤„ì–´ë“ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤!</p>\n<h2 id=\"ê²°ë¡ \"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ê²°ë¡ </h2>\n<p>spatial dataë¥¼ í•œ í…Œì´ë¸”ì— ë„ˆë¬´ ë§ì€ ë°ì´í„°ë¥¼ ë„£ìœ¼ë©´ indexì—°ì‚°í• ë•Œ ì›í•˜ì§€ ì•ŠëŠ” ë°©ì‹ìœ¼ë¡œ ê³„ì‚°í•  ì—¬ì§€ê°€ ìˆìŠµë‹ˆë‹¤.\në”°ë¼ì„œ ìµœëŒ€í•œ ì‹¤ì œ applicationì´ í•„ìš”ë¡œ í•˜ëŠ” ë°ì´í„°ë§Œì„ ì¶”ë ¤ì„œ materialized viewë¡œ ë§Œë“ ë‹¤ë©´ ì„±ëŠ¥ì— ê°œì„ ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì¦‰, <strong>ê¸°ë³¸ì— ì¶©ì‹¤í•˜ê²Œ ìƒê°í•˜ë©´ ë©ë‹ˆë‹¤â€¦</strong> ğŸ˜‚</p>\n<h2 id=\"ë§ˆì¹˜ë©°\"><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ë§ˆì¹˜ë©°</h2>\n<p>ì´ë¡œì¨ <strong>Spatial data</strong>ì˜ ì„±ëŠ¥ì„ <strong>10,000ë°° UP!</strong> ì‹œí‚¨ ì´ì•¼ê¸°ê°€ ëì´ ë‚¬ìŠµë‹ˆë‹¤.\nì´ë²ˆ ì‚¬ë¡€ë¥¼ í†µí•´ ë§ì€ ê²ƒì„ ë°°ìš¸ ìˆ˜ ìˆì—ˆëŠ”ë°ìš”. <strong>postgresqlì´ indexë¥¼ íƒ€ëŠ” ê²ƒì´ ë¹„íš¨ìœ¨ì ì´ë¼ íŒë‹¨ë˜ë©´ í’€ì„œì¹˜í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ optimizeí•œë‹¤</strong>ëŠ” ê²ƒì„ ì•Œê²Œ ë˜ì—ˆì„ ë¿ë§Œ ì•„ë‹ˆë¼ <strong>ê¸°ë³¸ì— ì¶©ì‹¤í•˜ì..^^</strong> ëŠ” êµí›ˆ ì—­ì‹œ ì–»ì„ ìˆ˜ ìˆì—ˆìŠµë‹ˆë‹¤!\nì•ìœ¼ë¡œë„ ì¢‹ì€ ì‚¬ë¡€ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ ì°¾ì•„ì˜¤ê² ìŠµë‹ˆë‹¤ :)</p>\n<p>ê·¸ë¦¬ê³  ëŠ˜ ì¢‹ì€ ë¬¼ë¥˜ BPO ì„œë¹„ìŠ¤ë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ ë…¸ë ¥í•˜ê³  ìˆëŠ” ë©”ì‰¬ì½”ë¦¬ì•„ ë¶€ë¦‰, ë§ì´ ì§€ì¼œë´ì£¼ì„¸ìš”!</p>\n<p>ê¸´ ê¸€ ì½ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤ ğŸ˜Š</p>","excerpt":"ì•ˆë…•í•˜ì„¸ìš”. ë©”ì‰¬ì½”ë¦¬ì•„ ê¸°ë°˜ì„œë¹„ìŠ¤ì„œë²„íŒ€ ê°•ì„±ì¼ì…ë‹ˆë‹¤.\nì´ë²ˆì— Spatial dataë¥¼  10,00â€¦","tableOfContents":"<ul>\n<li><a href=\"/20210120-dev-note-001-spatial-data/#spatial-data%EC%9D%98-intersects%EC%9D%98-%EA%B3%84%EC%82%B0-%EB%B0%A9%EB%B2%95\">Spatial dataì˜ intersectsì˜ ê³„ì‚° ë°©ë²•</a></li>\n<li><a href=\"/20210120-dev-note-001-spatial-data/#%EA%B7%B8%EB%9F%AC%EB%A9%B4-%EB%AC%B8%EC%A0%9C%EB%8A%94-%EC%96%B4%EB%94%94%EC%84%9C-%EB%B0%9C%EC%83%9D%ED%95%98%EB%8A%94%EA%B1%B8%EA%B9%8C\">ê·¸ëŸ¬ë©´ ë¬¸ì œëŠ” ì–´ë””ì„œ ë°œìƒí•˜ëŠ”ê±¸ê¹Œ?</a></li>\n<li><a href=\"/20210120-dev-note-001-spatial-data/#%EA%B2%B0%EB%A1%A0\">ê²°ë¡ </a></li>\n<li><a href=\"/20210120-dev-note-001-spatial-data/#%EB%A7%88%EC%B9%98%EB%A9%B0\">ë§ˆì¹˜ë©°</a></li>\n</ul>","fields":{"slug":"/20210120-dev-note-001-spatial-data/","github":"https://github.com/Luavis/luavis.github.io/blob/master/_posts/server/2020-11-19-how-to-deal-with-spatial-data.md","playstore":"","appstore":"","link":"https://b.luavis.kr/server/how-to-deal-with-spatial-data","linkDesc":""},"frontmatter":{"author":{"id":"ê°•ì„±ì¼","name":"ê°•ì„±ì¼","bio":"ì„œë¹„ìŠ¤ê°œë°œë³¸ë¶€ì—ì„œ ê¸°ë°˜ì„œë¹„ìŠ¤ì„œë²„ íŒ€ì˜ í…Œí¬ë¦¬ë“œë¥¼ ë‹´ë‹¹í•˜ê³  ìˆìŠµë‹ˆë‹¤.","avatar":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/2effd74b992c028704e743fcc1a02cc3/a2408/sungil.kang.png"}}]}},"date":"2021-01-20","title":"Spatial dataë¥¼ 10,000ë°° ì˜ ë‹¤ë£¨ê²Œ ëœ ë°©ë²•  ","tags":["postgis","Dev Notes"],"titleImage":{"childImageSharp":{"resize":{"src":"/static/ad64801ca72ee0533e938309b5ed95a0/eeb1b/title.png"}}}}}},"pageContext":{"slug":"/20210120-dev-note-001-spatial-data/"}},"staticQueryHashes":["1963140206"]}