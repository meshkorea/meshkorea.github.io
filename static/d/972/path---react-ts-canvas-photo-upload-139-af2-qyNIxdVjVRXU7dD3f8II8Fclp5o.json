{"data":{"site":{"siteMetadata":{"title":"Mesh Korea Makers Blog","description":"메쉬코리아에서 기술, 유저 경험 및 공간 디자인, 서비스 기획 등 물류플랫폼을 만들기 위한 과정에 대한 고민과 그 해결을 담은 블로그입니다."}},"markdownRemark":{"html":"<h4 id=\"들어가기에-앞서\"><a href=\"#%EB%93%A4%EC%96%B4%EA%B0%80%EA%B8%B0%EC%97%90-%EC%95%9E%EC%84%9C\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>들어가기에 앞서</h4>\n<p>인물사진을 등록하는 과제가 주어졌습니다. 여권 사진이나 증명사진처럼 어느 정도 여백이 있고 얼굴의 이목구비가 잘 드러나는 사진을 업로드해서 검증하는 과제입니다. 사진을 업로드하면 얼굴을 중심으로 이미지를 크롭하고 리사이징하며, 검사 조건을 충족하는지 확인합니다.</p>\n<p>얼굴 인식의 검사 조건은 아래와 같습니다.</p>\n<ul>\n<li>얼굴이 하나만 인식될 것</li>\n<li>얼굴이 너무 작거나 너무 크지 않을 것</li>\n<li>얼굴이 화면의 정중앙에 놓일 것\n얼굴 인식 및 검사는 Google Cloud Vision API를 활용합니다. 이 기술을 적용해야 하는 회사 프로덕트는 React에 TypeScript가 적용되어 있기 때문에 예제도 해당 부분을 반영해서 작성합니다. 또한, PostCSS 대신 Styled-Components를 활용하므로 코드 내 이 부분이 반영되어 있을 수 있습니다.</li>\n</ul>\n<h2 id=\"react-typescript-프로덕트에-html5-canvas와-google-vision-api를-활용한-인물사진-유효성-검사하기\"><a href=\"#react-typescript-%ED%94%84%EB%A1%9C%EB%8D%95%ED%8A%B8%EC%97%90-html5-canvas%EC%99%80-google-vision-api%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%EC%9D%B8%EB%AC%BC%EC%82%AC%EC%A7%84-%EC%9C%A0%ED%9A%A8%EC%84%B1-%EA%B2%80%EC%82%AC%ED%95%98%EA%B8%B0\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>React-TypeScript 프로덕트에 HTML5 canvas와 Google Vision API를 활용한 인물사진 유효성 검사하기</h2>\n<h3 id=\"1-google-cloud-vision-api-활용하기\"><a href=\"#1-google-cloud-vision-api-%ED%99%9C%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Google Cloud Vision API 활용하기</h3>\n<p>Google Cloud Vision API를 활용해 얼굴 인식을 하려면 기본적으로 구글 콘솔을 통해 발급한 API 키가 필요합니다. 이 과정에 대해서는 따로 설명하지 않습니다. 아래 링크를 통해 Cloud Vision API 키를 발급받으세요.</p>\n<blockquote>\n<p><a href=\"https://cloud.google.com/vision/docs/before-you-begin\">Enable the Vision API</a></p>\n</blockquote>\n<p>그 외 클라이언트에서는 따로 해줄 게 없습니다(처음엔 @google-api/vision 라이브러리의 설치가 필요한 줄 알아서 라이브러리를 설치했다가 호출에 실패하는 등의 시행착오를 거쳤습니다). API 호출은 fetch를 통해 이루어집니다. (물론 axios 같은 라이브러리를 활용해도 좋습니다)</p>\n<p>또한, API 호출을 위한 데이터 모델은 <a href=\"https://github.com/ClareKang/react-ts-canvas-photo-upload/blob/master/src/Photo.ts\">src/Photo.ts</a>에 인터페이스를 따로 정의했으며, 인터페이스의 이름은 대부분 구글 API의 명세를 따랐습니다.</p>\n<blockquote>\n<p>얼굴 인식에 관련된 구글 API의 명세는 아래와 같습니다.<br/>\n<a href=\"https://cloud.google.com/vision/docs/detecting-faces#vision-face-detection-gcs-protocol\">Detecting Faces | Cloud Vision API Documentation | Google Cloud</a></p>\n</blockquote>\n<h3 id=\"2-사진-편집을-위해-html5의-canvas-도입\"><a href=\"#2-%EC%82%AC%EC%A7%84-%ED%8E%B8%EC%A7%91%EC%9D%84-%EC%9C%84%ED%95%B4-html5%EC%9D%98-canvas-%EB%8F%84%EC%9E%85\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 사진 편집을 위해 HTML5의 canvas 도입</h3>\n<p>주어진 과제에는 사진 편집 기능이 들어갑니다. 얼굴을 화면의 중앙에 배치하며 지정된 배율로 잘라내고, 지정된 크기로 리사이징을 합니다. 이를 보다 쉽게 활용하기 위해 canvas를 도입했습니다. 대체로 canvas는 id를 부여하고 document.getElementById()를 통해 해당 element를 받아 처리하는 방식으로 사용하지만, React에서는 VirtualDOM을 활용한 렌더링을 하므로 위와 같은 사용 방식은 적절하지 않습니다. 다소 번거롭고 코드가 예쁘지 않지만 레퍼런스를 활용해 코드를 작성하게 되었습니다.</p>\n<h3 id=\"3-진행-과정은-아래와-같습니다\"><a href=\"#3-%EC%A7%84%ED%96%89-%EA%B3%BC%EC%A0%95%EC%9D%80-%EC%95%84%EB%9E%98%EC%99%80-%EA%B0%99%EC%8A%B5%EB%8B%88%EB%8B%A4\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 진행 과정은 아래와 같습니다.</h3>\n<ol>\n<li>지정된 파일 확장자만 업로드 가능한 파일 업로드 input 만들기</li>\n<li>FileReader를 활용해 업로드한 이미지를 base64로 인코딩하기</li>\n<li>파일 업로드 시 Vision API를 통해 사진 검증받기</li>\n<li>검증 후 조건에 맞지 않는 오류가 있으면 오류 메시지 표시하기</li>\n<li>캔버스에 사진 크롭 및 리사이징해서 그려주기</li>\n</ol>\n<h4 id=\"1-지정된-파일-확장자만-업로드-가능한-파일-업로드-input-만들기\"><a href=\"#1-%EC%A7%80%EC%A0%95%EB%90%9C-%ED%8C%8C%EC%9D%BC-%ED%99%95%EC%9E%A5%EC%9E%90%EB%A7%8C-%EC%97%85%EB%A1%9C%EB%93%9C-%EA%B0%80%EB%8A%A5%ED%95%9C-%ED%8C%8C%EC%9D%BC-%EC%97%85%EB%A1%9C%EB%93%9C-input-%EB%A7%8C%EB%93%A4%EA%B8%B0\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 지정된 파일 확장자만 업로드 가능한 파일 업로드 input 만들기</h4>\n<p>사실, 이 과정은 쉽습니다. HTML이 기본으로 제공하는 <code class=\"language-text\">&lt;input type=&quot;file&quot; /&gt;</code>을 활용하면 됩니다. App의 render에 input을 추가하고, file upload를 핸들 하는 함수를 App에 추가합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span><span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span>\n      <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>file<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>photo<span class=\"token punctuation\">\"</span></span>\n      <span class=\"token attr-name\">onChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>handleOnFileUpload<span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>file<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">accept</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>.jpg,.png,.bmp,.jpeg<span class=\"token punctuation\">\"</span></span>\n    <span class=\"token punctuation\">/></span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token operator\">...</span>\n\n  <span class=\"token keyword\">private</span> handleOnFileUpload <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">:</span> React<span class=\"token punctuation\">.</span>ChangeEvent<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>HTMLInputElement</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">) => </span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n      e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>files <span class=\"token operator\">&amp;&amp;</span>\n      e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        file<span class=\"token punctuation\">:</span> e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span><span class=\"token plain-text\">;\n}</span></code></pre></div>\n<blockquote>\n<p>input에는 <code class=\"language-text\">accept</code> attribute를 통해 지정된 파일 확장자만 업로드 가능하도록 합니다.</p>\n</blockquote>\n<h4 id=\"2-filereader를-활용해-업로드한-이미지를-base64로-인코딩하기\"><a href=\"#2-filereader%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%B4-%EC%97%85%EB%A1%9C%EB%93%9C%ED%95%9C-%EC%9D%B4%EB%AF%B8%EC%A7%80%EB%A5%BC-base64%EB%A1%9C-%EC%9D%B8%EC%BD%94%EB%94%A9%ED%95%98%EA%B8%B0\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. FileReader를 활용해 업로드한 이미지를 base64로 인코딩하기</h4>\n<p>Vision API는 이미지 파일을 base64 인코딩 되어 받기를 원합니다. 그래서 우리는 방금 업로드한 이미지 파일을 base64로 인코딩하는 과정을 거쳐야 합니다. 이 과정은 FileReader를 통해 진행합니다.\nhandleOnFileUpload 함수에 FileReader와 관련된 내용을 추가합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">private</span> <span class=\"token function-variable function\">handleOnFileUpload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">:</span> React<span class=\"token punctuation\">.</span>ChangeEvent<span class=\"token operator\">&lt;</span>HTMLInputElement<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> reader <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">FileReader</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  reader<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">onload</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> imageData <span class=\"token operator\">=</span> reader<span class=\"token punctuation\">.</span>result<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">\",\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  reader<span class=\"token punctuation\">.</span><span class=\"token function\">readAsDataURL</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>reader가 onload 되면 여러가지 값을 가지게 되는데, 그중 <code class=\"language-text\">result</code> 값이 바로 base64로 인코딩된 값입니다. 다만 result에는 <code class=\"language-text\">data:image/png;base64</code>,와 같은 prefix가 붙기 때문에 이 부분을 제외하고 전달해야 합니다. 따라서 ”,“을 기준으로 split 한 다음 ”,“이후의 값만 전달하도록 합니다.</p>\n<h4 id=\"3-파일-업로드-시-vision-api를-통해-사진-검증받기\"><a href=\"#3-%ED%8C%8C%EC%9D%BC-%EC%97%85%EB%A1%9C%EB%93%9C-%EC%8B%9C-vision-api%EB%A5%BC-%ED%86%B5%ED%95%B4-%EC%82%AC%EC%A7%84-%EA%B2%80%EC%A6%9D%EB%B0%9B%EA%B8%B0\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 파일 업로드 시 Vision API를 통해 사진 검증받기</h4>\n<p>이제 fetch를 활용해 Vision API로 이미지를 데이터를 받아와 보겠습니다. API POST로 호출하기 때문에 Request body를 먼저 작성합니다. 구글 문서를 보며 body를 작성합니다. 우리는 얼굴 인식을 활용할 것이기 때문에 <code class=\"language-text\">features.type</code>는 “FACE_DETECTION”으로 작성합니다. 그리고 <code class=\"language-text\">image.content</code>에는 위에서 base64로 인코딩된 이미지 데이터를 넣어줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> body <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  requests<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">{</span>\n      image<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        content<span class=\"token punctuation\">:</span> imageData<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      features<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">type</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"FACE_DETECTION\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>그리고 fetch 또한 작성합니다.\n아래 소스 코드의 “GOOGLE-CLOUD-VISION-KEY” 부분에 <a href=\"#1-google-cloud-vision-api-%ED%99%9C%EC%9A%A9%ED%95%98%EA%B8%B0\">1. Google Cloud Vision API 활용하기</a>에서 발급받은 API 키를 입력합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">public</span> <span class=\"token function\">uploadPhoto</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">:</span> AgentPhotoRequests<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Promise<span class=\"token operator\">&lt;</span>AgentPhotoResponses<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>\n    <span class=\"token template-string\"><span class=\"token string\">`https://vision.googleapis.com/v1/images:annotate?key=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>\n      <span class=\"token string\">\"GOOGLE-CLOUD-VISION-KEY\"</span>\n    <span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">`</span></span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      method<span class=\"token punctuation\">:</span> <span class=\"token string\">\"POST\"</span><span class=\"token punctuation\">,</span>\n      headers<span class=\"token punctuation\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Headers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        Accept<span class=\"token punctuation\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      body<span class=\"token punctuation\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>res <span class=\"token operator\">=></span> res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 소스코드를 실행해 보면 업로드된 사진을 분석한 데이터를 전달받게 됩니다. 절반쯤 왔군요. 이제부터는 수학과의 싸움입니다.</p>\n<h4 id=\"4-검증-후-조건에-맞지-않는-오류가-있으면-오류-메시지-표시하기\"><a href=\"#4-%EA%B2%80%EC%A6%9D-%ED%9B%84-%EC%A1%B0%EA%B1%B4%EC%97%90-%EB%A7%9E%EC%A7%80-%EC%95%8A%EB%8A%94-%EC%98%A4%EB%A5%98%EA%B0%80-%EC%9E%88%EC%9C%BC%EB%A9%B4-%EC%98%A4%EB%A5%98-%EB%A9%94%EC%8B%9C%EC%A7%80-%ED%91%9C%EC%8B%9C%ED%95%98%EA%B8%B0\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 검증 후 조건에 맞지 않는 오류가 있으면 오류 메시지 표시하기</h4>\n<p><code class=\"language-text\">getPhotoInfo</code>라는 함수를 작성해서 사진의 값을 분석하고 캔버스에 렌더링하도록 좌표를 계산해서 보내줄 겁니다. parameter로 Vision API의 response와 업로드한 이미지의 가로, 세로 값을 보내줍니다. 만약 검증 과정에서 오류가 있다면 오류 메시지만 리턴합니다.</p>\n<ul>\n<li>먼저 얼굴이 하나만 인식되는지 확인해봅니다.\n<code class=\"language-text\">response.responses.length</code> 가 0 혹은 1을 초과할 경우 오류 메시지를 표시합니다. 서로 오류 메시지가 다르므로 조건문을 분리해서 메시지를 보내도록 합니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">private</span> <span class=\"token function\">getPhotoInfo</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">:</span> AgentPhotoResponse<span class=\"token punctuation\">,</span> imgWidth<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">,</span> imgHeight<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 얼굴이 인식되지 않은 경우</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>responses<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"얼굴이 인식되지 않습니다.\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// 얼굴이 두 개 이상 인식된 경우</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>responses<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"얼굴이 하나인 사진만 승인됩니다.\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li>이제 얼굴 한 개의 좌표를 구합니다. 아마 최대값으로 보내줄 것이라고 예상하지만, 혹시 모르니 각 꼭짓점의 최대값을 구하도록 합니다. 이 값을 통해 우리는 얼굴이 사진에서 차지하는 너비 및 우리가 기대하는 이미지의 크기를 얻을 수 있습니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token comment\">// 얼굴을 구성하는 각 꼭짓점의 최댓값 구하기</span>\n<span class=\"token keyword\">const</span> faceDetection <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>responses<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>faceAnnotations<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> topBound<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> bottomBound<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> leftBound<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> rightBound<span class=\"token punctuation\">:</span> <span class=\"token builtin\">number</span> <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\nfaceDetection<span class=\"token punctuation\">.</span>fdBoundingPoly<span class=\"token punctuation\">.</span>vertices<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>vertice<span class=\"token punctuation\">:</span> Vertice<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>topBound <span class=\"token operator\">||</span> vertice<span class=\"token punctuation\">.</span>y <span class=\"token operator\">&lt;</span> topBound<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    topBound <span class=\"token operator\">=</span> vertice<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>bottomBound <span class=\"token operator\">||</span> vertice<span class=\"token punctuation\">.</span>y <span class=\"token operator\">></span> bottomBound<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    bottomBound <span class=\"token operator\">=</span> vertice<span class=\"token punctuation\">.</span>y<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>leftBound <span class=\"token operator\">||</span> vertice<span class=\"token punctuation\">.</span>x <span class=\"token operator\">&lt;</span> leftBound<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    leftBound <span class=\"token operator\">=</span> vertice<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>rightBound <span class=\"token operator\">||</span> vertice<span class=\"token punctuation\">.</span>x <span class=\"token operator\">></span> rightBound<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    rightBound <span class=\"token operator\">=</span> vertice<span class=\"token punctuation\">.</span>x<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> faceWidth <span class=\"token operator\">=</span> rightBound <span class=\"token operator\">-</span> leftBound<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> cropWidth <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>faceWidth <span class=\"token operator\">/</span> <span class=\"token punctuation\">{</span>얼굴이 전체 사진에서 차지하는 비율<span class=\"token punctuation\">}</span> <span class=\"token operator\">*</span> <span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> cropHeight <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>cropWidth <span class=\"token operator\">/</span> <span class=\"token punctuation\">{</span>사진의 가로세로 비율<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li>\n<p>얼굴이 전체 사진에서 차지하는 비율은 0-100사이로 입력합니다. 얼굴이 전체 사진에서 40%를 차지하도록 하고 싶다면 40으로 입력하면 됩니다.</p>\n</li>\n<li>\n<p>사진의 가로 세로 비율은 (가로 / 세로) 값을 사용하면 됩니다. 만약 가로 300픽셀 세로 400픽셀의 결과값을 원한다면 0.75가 됩니다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">cropWidth</code>는 사진이 크롭 될 경우 기대하는 너비 값이 되고, <code class=\"language-text\">cropHeight</code>는 크롭 될 경우 기대하는 높이 값이 됩니다.</p>\n</li>\n<li>\n<p>그리고 크롭 된 이미지의 가로가 최소로 기대하는 가로 값보다 작으면 오류 메시지를 리턴합니다. 만약 400픽셀 이상의 이미지를 원하는데 크롭 된 이미지가 300픽셀이라면 아래 메시지가 표시될 것입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>cropWidth <span class=\"token operator\">&lt;</span> <span class=\"token punctuation\">{</span>최소로 기대하는 가로 값<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"지금보다 얼굴이 크게 보여야 합니다.\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p>이제 크롭 된 이미지의 좌표를 계산합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">const</span> top <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>topBound <span class=\"token operator\">-</span> cropHeight <span class=\"token operator\">*</span> facePositionTop<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> bottom <span class=\"token operator\">=</span> top <span class=\"token operator\">+</span> cropHeight<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> horizontalCenter <span class=\"token operator\">=</span> leftBound <span class=\"token operator\">+</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>faceWidth <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> left <span class=\"token operator\">=</span> horizontalCenter <span class=\"token operator\">-</span> cropWidth <span class=\"token operator\">/</span> <span class=\"token number\">2</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> right <span class=\"token operator\">=</span> left <span class=\"token operator\">+</span> cropWidth<span class=\"token punctuation\">;</span></code></pre></div>\n<p>faceWidth의 중심 값인 <code class=\"language-text\">horizontalCenter</code>를 구합니다. 이를 바탕으로 <code class=\"language-text\">left</code>값과 <code class=\"language-text\">right</code>값을 구합니다.</p>\n</li>\n<li>\n<p>마지막 검증 과정을 작성합니다. 얼굴 좌표가 캔버스를 벗어나게 되면 이 사진은 우리가 원하는 결과에 적합하지 않은 사진이 됩니다.</p>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>left <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> top <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span> <span class=\"token operator\">||</span> right <span class=\"token operator\">></span> imgWidth <span class=\"token operator\">||</span> bottom <span class=\"token operator\">></span> imgHeight<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    info<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n      x<span class=\"token punctuation\">:</span> left<span class=\"token punctuation\">,</span>\n      y<span class=\"token punctuation\">:</span> top<span class=\"token punctuation\">,</span>\n      width<span class=\"token punctuation\">:</span> cropWidth<span class=\"token punctuation\">,</span>\n      height<span class=\"token punctuation\">:</span> cropHeight<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"얼굴이 화면 정중앙에 놓여야 합니다.\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">imgWidth</code>, <code class=\"language-text\">imgHeight</code>는 각각 실제 업로드된 이미지의 가로와 세로에 해당합니다. 만약 실제 이미지를 초과한 값이 발생하면 이것 역시 결과에 적합하지 않은 이미지가 됩니다.</li>\n</ul>\n<p>모든 검사 조건을 통과했다면, 이미지를 캔버스에 그릴 수 있도록 메시지와 함께 좌표값을 리턴합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n  info<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n    x<span class=\"token punctuation\">:</span> left<span class=\"token punctuation\">,</span>\n    y<span class=\"token punctuation\">:</span> top<span class=\"token punctuation\">,</span>\n    width<span class=\"token punctuation\">:</span> cropWidth<span class=\"token punctuation\">,</span>\n    height<span class=\"token punctuation\">:</span> cropHeight<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  message<span class=\"token punctuation\">:</span> <span class=\"token string\">\"사진이 등록되었습니다.\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h4 id=\"5-캔버스에-사진-크롭-및-리사이징해서-그려주기\"><a href=\"#5-%EC%BA%94%EB%B2%84%EC%8A%A4%EC%97%90-%EC%82%AC%EC%A7%84-%ED%81%AC%EB%A1%AD-%EB%B0%8F-%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95%ED%95%B4%EC%84%9C-%EA%B7%B8%EB%A0%A4%EC%A3%BC%EA%B8%B0\" aria-hidden=\"true\" class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>5. 캔버스에 사진 크롭 및 리사이징해서 그려주기</h4>\n<p>드디어 캔버스의 차례가 왔습니다. 다만, 캔버스에 사진을 렌더링 하는 과정은 통과 여부와 상관없이 진행됩니다. 왜냐하면 오류가 있는 것 또한 시각적으로 표시해줘야 하기 때문입니다.</p>\n<ul>\n<li>일단 캔버스를 render에 추가해볼까요? canvas는 앞서 말했듯, 레퍼런스로 관리됩니다. 그렇게 작동하기 위해서는 아래와 같이 코드를 작성합니다. canvas 변수를 App 상단에 선언하고, render에 canvas element를 작성합니다. 그리고 마지막으로 this.canvas가 canvas element를 가리킬 수 있도록 refCanvas를 작성해줍니다. 그러면 앞으로 우리는 this.canvas를 통해 canvas element에 접근할 수 있게 됩니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token keyword\">private</span> canvas<span class=\"token punctuation\">:</span> HTMLCanvasElement<span class=\"token punctuation\">;</span>\n<span class=\"token operator\">...</span>\n<span class=\"token keyword\">public</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">...</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>canvas</span>\n      <span class=\"token attr-name\">ref</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>refCanvas<span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">width</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>canvasWidth<span class=\"token punctuation\">}</span></span>\n      <span class=\"token attr-name\">height</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>canvasHeight<span class=\"token punctuation\">}</span></span>\n    <span class=\"token punctuation\">/></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token operator\">...</span>\n<span class=\"token keyword\">private</span> <span class=\"token function-variable function\">refCanvas</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>canvas<span class=\"token punctuation\">:</span> HTMLCanvasElement<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>canvas <span class=\"token operator\">=</span> canvas<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">canvasWidth</code>, <code class=\"language-text\">canvasHeight</code>는 사진을 렌더 할 캔버스의 크기를 나타냅니다.</li>\n<li>위에서 <code class=\"language-text\">getPhotoInfo</code> 함수를 통해 가져온 값을 활용해 캔버스에 이미지를 렌더 합니다. 하지만 그전에 검증 과정에서 통과 못해 메시지만 보낸 경우가 있었으니 그것부터 처리를 해줍니다. 결과값을 result라는 파라미터로 전달합니다. 그리고 메시지가 있는지 확인하고 메시지가 있는 경우 setState를 통해 메시지를 state에 저장합니다. drawInCanvas 함수를 통해 캔버스에 사진을 그립니다. result 중 메시지는 캔버스 렌더링과 무관하므로 좌표값을 포함한 <code class=\"language-text\">result.info</code> 값만 넘겨줍니다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span>result<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    message<span class=\"token punctuation\">:</span> result<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">drawInCanvas</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span>info<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>대망의 캔버스 렌더링입니다. <code class=\"language-text\">getContext(&quot;2d&quot;)</code>를 사용해 캔버스의 컨텍스트를 가져갑니다. 만약 위의 result에서 메시지만 넘어오고 info(좌표값)가 넘어오지 않았을 경우 사진 이미지는 원본 그대로 렌더링하도록 합니다. result에서 좌표가 올바르게 넘어왔을 경우 사진을 좌표값에 맞게 렌더링 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">private</span> <span class=\"token function-variable function\">drawInCanvas</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>photoInfo<span class=\"token punctuation\">:</span> PhotoInfo<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> ctx <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>canvas<span class=\"token punctuation\">.</span><span class=\"token function\">getContext</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"2d\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span>ctx<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 시작에 앞서 canvas에 렌더링 된 데이터를 삭제합니다.</span>\n    ctx<span class=\"token punctuation\">.</span><span class=\"token function\">clearRect</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> canvasWidth<span class=\"token punctuation\">,</span> canvasHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span><span class=\"token operator\">!</span>photoInfo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> x<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">,</span> width<span class=\"token punctuation\">,</span> height <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> photoInfo<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> ratio <span class=\"token operator\">=</span> canvasWidth <span class=\"token operator\">/</span> width<span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// 조건을 충족하지 못해 사진이 부족할 경우 오류를 시각적으로 표시하기 위해 오류 배경을 먼저 캔버스에 채웁니다.</span>\n      ctx<span class=\"token punctuation\">.</span><span class=\"token function\">drawImage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>errorBackground<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> canvasWidth<span class=\"token punctuation\">,</span> canvasHeight<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// 그리고 만약 배경이 투명한 이미지를 올릴 경우 배경과 분리되어 보이지 않을 가능성이 있어 하얀색 사각형을 먼저 배경에 그려줍니다.</span>\n      ctx<span class=\"token punctuation\">.</span>fillStyle <span class=\"token operator\">=</span> <span class=\"token string\">\"#fff\"</span><span class=\"token punctuation\">;</span>\n      ctx<span class=\"token punctuation\">.</span><span class=\"token function\">fillRect</span><span class=\"token punctuation\">(</span>\n        x <span class=\"token operator\">*</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">*</span> ratio<span class=\"token punctuation\">,</span>\n        y <span class=\"token operator\">*</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">*</span> ratio<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>img<span class=\"token punctuation\">.</span>width <span class=\"token operator\">*</span> ratio<span class=\"token punctuation\">,</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>img<span class=\"token punctuation\">.</span>height <span class=\"token operator\">*</span> ratio<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// 이제 업로드된 이미지를 캔버스에 렌더링 합니다.</span>\n      ctx<span class=\"token punctuation\">.</span><span class=\"token function\">drawImage</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>img<span class=\"token punctuation\">,</span>\n        x<span class=\"token punctuation\">,</span>\n        y<span class=\"token punctuation\">,</span>\n        width<span class=\"token punctuation\">,</span>\n        height<span class=\"token punctuation\">,</span>\n        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n        Math<span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>width <span class=\"token operator\">*</span> ratio<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        Math<span class=\"token punctuation\">.</span><span class=\"token function\">round</span><span class=\"token punctuation\">(</span>height <span class=\"token operator\">*</span> ratio<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// 좌표값이 없을 경우 (0, 0)부터 이미지를 렌더링 합니다.</span>\n      ctx<span class=\"token punctuation\">.</span><span class=\"token function\">drawImage</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>img<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>img<span class=\"token punctuation\">.</span>width<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>img<span class=\"token punctuation\">.</span>height<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>간단하게 끝날 줄 알았는데 생각보다 긴 과정이 되었네요. 이 예제를 통해 Vision API를 활용하는 법이나 React로 이루어진 프로덕트에 canvas를 활용할 수 있도록 도움이 되면 좋을 것 같습니다.</p>\n<hr>\n<p>\n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block; margin-left: -70px; margin-right: -70px; text-align: center; max-width: 980px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 92.3578751164958%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAADlUlEQVQ4y6WUW0wcZRTH50myL6RAgh0SaneAsrCaNJSWhG2sViWGBxDevSQkPixZE7SxaiFsw7JcAgi2VUqERdpq2gcIEh80aZqokWJbA1hMbcLe2JZZ2GUvs7fZ2Zm/Z2a3qw9NG/Ukv8zZ+b7z+3a+M/Mx8x9PPuPeWH5neeOWxeV0m71er9nn85l5nje73W6zR4Xueba2zC6Xy+x0Oh+HZX19/a2FhQUd8+6bHc/+8ftqyv3AC5fLDRLC4/GAZBrbPI8HXg98dM+/s4O9vT0Eg8E8gUAA0WgUa2trwlmr9SCzr2gfW22o2THWGlFTU5MmJIPBIFVVVUnVdK2m6+EXT0qHT7wiGQ4dkoxGo1RbW6uh5kSaANU8LC0t5ZjCwkJWr9cHKioqwHGcTCiUKyRUKisrFf2BcuWFl5uU5196TdE/d0DhaEwdV+flkNVacvDFxcUcU1BQwFISLCkpASFTjvLyctQdqUNDQwNMx4/jaF0djtLvYw3HUF9fr8Gy+1FUVKTVqLVUx+t0Oo4xmUzs0NBQcHx8HKOjo7LdbkdfX5+aw+FwYHZ2FtPT05i8eBHTMzOYu3RZy89fuKDNGRkZkScmJjA4OMg3NzdzTFdXFwsgiGzImUxG22QpI+OfIQhR/LbyCx56NrG1+Sdc9+89Gno0kSc5x5jNZjYWi2lCSZJkRZEhxOIYs5/Fp7ZexBMJKIqCaDiEK5Nj+HywF8PdH2BqzE6LCJApsgsKvM1m45jOzk42mUxqQkW1Uezu7uLacA/uzDsQoyI1YpEwFr+ewSXbKQy/9zauOr6AmErm/2EikeD7+/sfI8w6cWPuPO5+O5d/nrgQweI3DixN9OL6zCiufTVJwtSThepgKi1hYGEJr7/RjNPWj7DqdEOk/UzGBCxensJnfVbMnZvC0hUHSeJPF/oiAkqPmMA1nsSJ98/g9Cc9uL/thyKlcfXLcxjuOQPrqQ8xPzuFcCj0dKHT7cF33/+Amyu/4gbx408/IxAKIx6LYfXObdxeuYlbK8u4t3EX1MwnC9WOqd+nKKa0/Uln90gL9XVKiSLSkoRMtrG05383Mi9UXxsSBnJNyeRWlGmCHA6HNSKRiCyKopxbMx+qLFejCrc1ocViYdPpdAj/M8ixOzAwwDEdHR37/X6/JxQKpehoEojYv0SgpxDp/Nzs7u4+yJSVlRW0t7c3trS0NBGv/hdaW1ub2traGunk0f0FdhgLR1MSbGMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"DEMO\"\n        title=\"\"\n        src=\"/static/demo-b130893036ee40a3f6958a77cf2d8813-a347a.png\"\n        srcset=\"/static/demo-b130893036ee40a3f6958a77cf2d8813-ede82.png 245w,\n/static/demo-b130893036ee40a3f6958a77cf2d8813-c25e3.png 490w,\n/static/demo-b130893036ee40a3f6958a77cf2d8813-a347a.png 980w,\n/static/demo-b130893036ee40a3f6958a77cf2d8813-2c212.png 1470w,\n/static/demo-b130893036ee40a3f6958a77cf2d8813-19b2b.png 1960w,\n/static/demo-b130893036ee40a3f6958a77cf2d8813-f9cfa.png 2146w\"\n        sizes=\"(max-width: 980px) 100vw, 980px\"\n      />\n    </span>\n  </span>\n  </p>\n<p><strong>이 예제의 DEMO 페이지가 있습니다.</strong><br/>\n페이지 하단에 위치한 input에 구글에서 발급받은 API 키를 입력하고,\n구글 콘솔을 통해 <code class=\"language-text\">www.clarekang.me</code> 도메인에서 접근할 수 있도록 허용해야 합니다.</p>\n<p><a href=\"http://www.clarekang.me/react-ts-canvas-photo-upload/\">DEMO - React TypeScript Canvas Photo Upload</a></p>\n<p><small>이 예제에 활용된 소스코드는 Github에서 확인 가능합니다. (예제의 오류 메시지는 영문으로 표기되어있습니다.)<br/>\n<a href=\"https://github.com/ClareKang/react-ts-canvas-photo-upload\">https://github.com/ClareKang/react-ts-canvas-photo-upload</a>\n</small></p>","excerpt":"…","tableOfContents":"<ul>\n<li>\n<ul>\n<li>\n<ul>\n<li><a href=\"/react-ts-canvas-photo-upload/#%EB%93%A4%EC%96%B4%EA%B0%80%EA%B8%B0%EC%97%90-%EC%95%9E%EC%84%9C\">들어가기에 앞서</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"/react-ts-canvas-photo-upload/#react-typescript-%ED%94%84%EB%A1%9C%EB%8D%95%ED%8A%B8%EC%97%90-html5-canvas%EC%99%80-google-vision-api%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%9C-%EC%9D%B8%EB%AC%BC%EC%82%AC%EC%A7%84-%EC%9C%A0%ED%9A%A8%EC%84%B1-%EA%B2%80%EC%82%AC%ED%95%98%EA%B8%B0\">React-TypeScript 프로덕트에 HTML5 canvas와 Google Vision API를 활용한 인물사진 유효성 검사하기</a></p>\n<ul>\n<li><a href=\"/react-ts-canvas-photo-upload/#1-google-cloud-vision-api-%ED%99%9C%EC%9A%A9%ED%95%98%EA%B8%B0\">1. Google Cloud Vision API 활용하기</a></li>\n<li><a href=\"/react-ts-canvas-photo-upload/#2-%EC%82%AC%EC%A7%84-%ED%8E%B8%EC%A7%91%EC%9D%84-%EC%9C%84%ED%95%B4-html5%EC%9D%98-canvas-%EB%8F%84%EC%9E%85\">2. 사진 편집을 위해 HTML5의 canvas 도입</a></li>\n<li>\n<p><a href=\"/react-ts-canvas-photo-upload/#3-%EC%A7%84%ED%96%89-%EA%B3%BC%EC%A0%95%EC%9D%80-%EC%95%84%EB%9E%98%EC%99%80-%EA%B0%99%EC%8A%B5%EB%8B%88%EB%8B%A4\">3. 진행 과정은 아래와 같습니다.</a></p>\n<ul>\n<li><a href=\"/react-ts-canvas-photo-upload/#1-%EC%A7%80%EC%A0%95%EB%90%9C-%ED%8C%8C%EC%9D%BC-%ED%99%95%EC%9E%A5%EC%9E%90%EB%A7%8C-%EC%97%85%EB%A1%9C%EB%93%9C-%EA%B0%80%EB%8A%A5%ED%95%9C-%ED%8C%8C%EC%9D%BC-%EC%97%85%EB%A1%9C%EB%93%9C-input-%EB%A7%8C%EB%93%A4%EA%B8%B0\">1. 지정된 파일 확장자만 업로드 가능한 파일 업로드 input 만들기</a></li>\n<li><a href=\"/react-ts-canvas-photo-upload/#2-filereader%EB%A5%BC-%ED%99%9C%EC%9A%A9%ED%95%B4-%EC%97%85%EB%A1%9C%EB%93%9C%ED%95%9C-%EC%9D%B4%EB%AF%B8%EC%A7%80%EB%A5%BC-base64%EB%A1%9C-%EC%9D%B8%EC%BD%94%EB%94%A9%ED%95%98%EA%B8%B0\">2. FileReader를 활용해 업로드한 이미지를 base64로 인코딩하기</a></li>\n<li><a href=\"/react-ts-canvas-photo-upload/#3-%ED%8C%8C%EC%9D%BC-%EC%97%85%EB%A1%9C%EB%93%9C-%EC%8B%9C-vision-api%EB%A5%BC-%ED%86%B5%ED%95%B4-%EC%82%AC%EC%A7%84-%EA%B2%80%EC%A6%9D%EB%B0%9B%EA%B8%B0\">3. 파일 업로드 시 Vision API를 통해 사진 검증받기</a></li>\n<li><a href=\"/react-ts-canvas-photo-upload/#4-%EA%B2%80%EC%A6%9D-%ED%9B%84-%EC%A1%B0%EA%B1%B4%EC%97%90-%EB%A7%9E%EC%A7%80-%EC%95%8A%EB%8A%94-%EC%98%A4%EB%A5%98%EA%B0%80-%EC%9E%88%EC%9C%BC%EB%A9%B4-%EC%98%A4%EB%A5%98-%EB%A9%94%EC%8B%9C%EC%A7%80-%ED%91%9C%EC%8B%9C%ED%95%98%EA%B8%B0\">4. 검증 후 조건에 맞지 않는 오류가 있으면 오류 메시지 표시하기</a></li>\n<li><a href=\"/react-ts-canvas-photo-upload/#5-%EC%BA%94%EB%B2%84%EC%8A%A4%EC%97%90-%EC%82%AC%EC%A7%84-%ED%81%AC%EB%A1%AD-%EB%B0%8F-%EB%A6%AC%EC%82%AC%EC%9D%B4%EC%A7%95%ED%95%B4%EC%84%9C-%EA%B7%B8%EB%A0%A4%EC%A3%BC%EA%B8%B0\">5. 캔버스에 사진 크롭 및 리사이징해서 그려주기</a></li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>","fields":{"slug":"/react-ts-canvas-photo-upload/","github":"https://github.com/ClareKang/react-ts-canvas-photo-upload","playstore":"","appstore":"","link":"http://www.clarekang.me/react-ts-canvas-photo-upload","linkDesc":"라이브 데모 페이지 확인하기"},"frontmatter":{"author":{"id":"강민경","name":"강민경","bio":"플랫폼셀에서 웹 프론트엔드 개발과 고양이 덕후를 담당하고 있습니다냥!🐾","avatar":{"children":[{"__typename":"ImageSharp","fixed":{"src":"/static/mk.kang-e663b9e65055329e6111e197f446e9c2-15d86.jpg"}}]}},"date":"2018-07-16","title":"React-TypeScript 프로덕트에서 인물사진 유효성 검사하기","tags":"react, typescript, google api, canvas","titleImage":{"childImageSharp":{"resize":{"src":"/static/header-a5858368e4be5fbd7718722f37e62ab9-9c1d4.png"}}}}}},"pageContext":{"slug":"/react-ts-canvas-photo-upload/"}}